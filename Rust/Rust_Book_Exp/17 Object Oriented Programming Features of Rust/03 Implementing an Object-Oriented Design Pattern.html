<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>17.3. 状态模式 | Lindorof</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Lindorof's Blog">
    <link rel="preload" href="/assets/css/0.styles.8ac2847d.css" as="style"><link rel="preload" href="/assets/js/app.b639eb72.js" as="script"><link rel="preload" href="/assets/js/2.5df156af.js" as="script"><link rel="preload" href="/assets/js/86.47c806cb.js" as="script"><link rel="prefetch" href="/assets/js/10.ee4568ff.js"><link rel="prefetch" href="/assets/js/11.8db0767a.js"><link rel="prefetch" href="/assets/js/12.92a4e660.js"><link rel="prefetch" href="/assets/js/13.e2450b62.js"><link rel="prefetch" href="/assets/js/14.5ae14743.js"><link rel="prefetch" href="/assets/js/15.62a967cf.js"><link rel="prefetch" href="/assets/js/16.3482df63.js"><link rel="prefetch" href="/assets/js/17.881a9d91.js"><link rel="prefetch" href="/assets/js/18.d6e19ee5.js"><link rel="prefetch" href="/assets/js/19.caf0829a.js"><link rel="prefetch" href="/assets/js/20.a80e123c.js"><link rel="prefetch" href="/assets/js/21.9c810086.js"><link rel="prefetch" href="/assets/js/22.bc5f69cb.js"><link rel="prefetch" href="/assets/js/23.f15ef55d.js"><link rel="prefetch" href="/assets/js/24.b8714e3e.js"><link rel="prefetch" href="/assets/js/25.d673c092.js"><link rel="prefetch" href="/assets/js/26.28d57b84.js"><link rel="prefetch" href="/assets/js/27.d8b15b76.js"><link rel="prefetch" href="/assets/js/28.2574be13.js"><link rel="prefetch" href="/assets/js/29.54667d47.js"><link rel="prefetch" href="/assets/js/3.f6602695.js"><link rel="prefetch" href="/assets/js/30.dd697263.js"><link rel="prefetch" href="/assets/js/31.aafbc8db.js"><link rel="prefetch" href="/assets/js/32.5fe2531d.js"><link rel="prefetch" href="/assets/js/33.c3dfca3c.js"><link rel="prefetch" href="/assets/js/34.22613e38.js"><link rel="prefetch" href="/assets/js/35.aad9af2b.js"><link rel="prefetch" href="/assets/js/36.badbd522.js"><link rel="prefetch" href="/assets/js/37.45905373.js"><link rel="prefetch" href="/assets/js/38.ab0de43e.js"><link rel="prefetch" href="/assets/js/39.d1a7492c.js"><link rel="prefetch" href="/assets/js/4.c7710dca.js"><link rel="prefetch" href="/assets/js/40.92c4cb14.js"><link rel="prefetch" href="/assets/js/41.cc19be50.js"><link rel="prefetch" href="/assets/js/42.c9b4b585.js"><link rel="prefetch" href="/assets/js/43.1af966c8.js"><link rel="prefetch" href="/assets/js/44.40ebac1c.js"><link rel="prefetch" href="/assets/js/45.469b8553.js"><link rel="prefetch" href="/assets/js/46.eb491d21.js"><link rel="prefetch" href="/assets/js/47.03d1fbf2.js"><link rel="prefetch" href="/assets/js/48.af296c16.js"><link rel="prefetch" href="/assets/js/49.3a42b55b.js"><link rel="prefetch" href="/assets/js/5.339eb2f5.js"><link rel="prefetch" href="/assets/js/50.ef35a161.js"><link rel="prefetch" href="/assets/js/51.284d50de.js"><link rel="prefetch" href="/assets/js/52.c4983004.js"><link rel="prefetch" href="/assets/js/53.83c193e1.js"><link rel="prefetch" href="/assets/js/54.08f26cd6.js"><link rel="prefetch" href="/assets/js/55.ef20313b.js"><link rel="prefetch" href="/assets/js/56.dc2772cf.js"><link rel="prefetch" href="/assets/js/57.add26447.js"><link rel="prefetch" href="/assets/js/58.ff8f2704.js"><link rel="prefetch" href="/assets/js/59.43fdbc04.js"><link rel="prefetch" href="/assets/js/6.0ce72a94.js"><link rel="prefetch" href="/assets/js/60.1a27c7c3.js"><link rel="prefetch" href="/assets/js/61.9ca63ff6.js"><link rel="prefetch" href="/assets/js/62.9ab09b12.js"><link rel="prefetch" href="/assets/js/63.a6b6d595.js"><link rel="prefetch" href="/assets/js/64.5e9ac56b.js"><link rel="prefetch" href="/assets/js/65.bcfb6015.js"><link rel="prefetch" href="/assets/js/66.5024eb22.js"><link rel="prefetch" href="/assets/js/67.5d83f99f.js"><link rel="prefetch" href="/assets/js/68.80f05874.js"><link rel="prefetch" href="/assets/js/69.6f9ff293.js"><link rel="prefetch" href="/assets/js/7.726c7fbf.js"><link rel="prefetch" href="/assets/js/70.92b749fb.js"><link rel="prefetch" href="/assets/js/71.a4248217.js"><link rel="prefetch" href="/assets/js/72.29aeb940.js"><link rel="prefetch" href="/assets/js/73.8918e90b.js"><link rel="prefetch" href="/assets/js/74.81fd32da.js"><link rel="prefetch" href="/assets/js/75.5357ccc2.js"><link rel="prefetch" href="/assets/js/76.66fc1725.js"><link rel="prefetch" href="/assets/js/77.6f29512b.js"><link rel="prefetch" href="/assets/js/78.a63871cd.js"><link rel="prefetch" href="/assets/js/79.c646997c.js"><link rel="prefetch" href="/assets/js/8.81d630fc.js"><link rel="prefetch" href="/assets/js/80.b5d5ad39.js"><link rel="prefetch" href="/assets/js/81.601aa569.js"><link rel="prefetch" href="/assets/js/82.99bc0640.js"><link rel="prefetch" href="/assets/js/83.06d4defc.js"><link rel="prefetch" href="/assets/js/84.44856307.js"><link rel="prefetch" href="/assets/js/85.3b88ee80.js"><link rel="prefetch" href="/assets/js/87.b5201cdf.js"><link rel="prefetch" href="/assets/js/88.f9ce8655.js"><link rel="prefetch" href="/assets/js/89.c1f12bf1.js"><link rel="prefetch" href="/assets/js/9.b6118830.js"><link rel="prefetch" href="/assets/js/90.e0f850a2.js"><link rel="prefetch" href="/assets/js/91.8166ca11.js"><link rel="prefetch" href="/assets/js/92.6ba6ce27.js"><link rel="prefetch" href="/assets/js/93.6e09fb58.js"><link rel="prefetch" href="/assets/js/94.1b324565.js"><link rel="prefetch" href="/assets/js/95.5308659f.js"><link rel="prefetch" href="/assets/js/96.306bee11.js"><link rel="prefetch" href="/assets/js/97.6e231fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ac2847d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Lindorof" class="logo"> <span class="site-name can-hide">Lindorof</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Rust/Rust_Book_Exp/" aria-current="page" class="sidebar-link">「RustBook」学习心得</a></li><li><a href="/Rust/Rust_Book_Exp/01 Getting Started/01 Getting Started.html" class="sidebar-link">1. 开始</a></li><li><a href="/Rust/Rust_Book_Exp/02 Programming a Guessing Game/01 Programming a Guessing Game.html" class="sidebar-link">2. 猜谜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3. 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>4. 所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>5. 结构体</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>6. 枚举</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>7. 模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>8. 集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>9. 错误处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>10. 泛型及生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>11. 自动测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>12. 命令行</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>13. 闭包及迭代器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>14. Cargo 和 Crates.io</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>15. 智能指针</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>16. 无畏并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>17. 面向对象</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Rust/Rust_Book_Exp/17 Object Oriented Programming Features of Rust/01 Characteristics of Object Oriented Languages.html" class="sidebar-link">17.1. 对象特征</a></li><li><a href="/Rust/Rust_Book_Exp/17 Object Oriented Programming Features of Rust/02 Using Trait Objects That Allow for Values of Different Types.html" class="sidebar-link">17.2. Trait 对象</a></li><li><a href="/Rust/Rust_Book_Exp/17 Object Oriented Programming Features of Rust/03 Implementing an Object-Oriented Design Pattern.html" class="active sidebar-link">17.3. 状态模式</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>18. 模式与匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>19. 高级特征</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_17-3-状态模式"><a href="#_17-3-状态模式" class="header-anchor">#</a> 17.3. 状态模式</h1> <p><em>源码：<a href="https://gitee.com/lindorof/Rust_The_Book/tree/master/ch17-3-blog" target="_blank" rel="noopener noreferrer">ch17-3-blog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>本节会讲解一种面向对象的设计模式：<em><strong>状态模式</strong></em>（<em><strong>state pattern</strong></em>）：</p> <ul><li>根据业务需求，设计出一系列的状态</li> <li>这些状态可以体现为一个个的 <em><strong>状态对象</strong></em>（<em><strong>state object</strong></em>）</li> <li>对于一个状态对象来说：
<ol><li>只负责在当前状态下的对应行为</li> <li>负责在某个时机（例如方法调用）转变为另一个状态</li></ol></li> <li>对于使用者（或包含这些状态对象的值）来说：
<ol><li>不知道当前处于什么状态</li> <li>不知道何时转变为下一个状态</li> <li>不知道某个行为（例如方法）调用在不同状态之间会有什么不同</li></ol></li></ul> <p>状态模式的优点：</p> <ul><li>当业务规则改变时，不需要更改使用者的代码</li> <li>而只需要更新某个状态对象中的代码</li> <li>或者增加更多的状态对象</li></ul> <p>状态模式的缺点：</p> <ul><li>由于一个状态需要负责转变到另一个状态，因此状态之间可能会相互联系</li> <li>例如，原先的状态规则是 A → B → C ，但在 A 和 B 之间增加了状态 A1 ，即 A → A1 → B → C ，则需要更改原先设计好的状态对象 A ，让 A 负责切换到 A1 而不是 B</li></ul> <p>关于状态模式的实现：</p> <ul><li>需要注意的是，所谓 <em><strong>状态模式</strong></em>（<em><strong>state pattern</strong></em>）和 <em><strong>状态对象</strong></em>（<em><strong>state object</strong></em>）只是设计模式中的术语</li> <li>设计模式只是讲解该模式的设计思路，不涉及具体的编程语言实现</li></ul> <p>在 rust 中可考虑几种实现方式：</p> <ul><li><p>将各个状态实现为 <em><strong>trait 对象</strong></em>（<em><strong>trait object</strong></em>）：</p> <ul><li>这些 trait 对象都具有同样的方法</li> <li>但同一个方法在不同的 trait 对象间具有不同的行为</li> <li>使用者不知道当前实际是什么状态，只负责调用方法</li> <li>但缺点是：
<ol><li>所有的 trait 对象都需要实现同样的方法，即使有些方法不该在此状态上调用（当然，调用了也不能产生影响，这是由该 trait 对象来保证的，而正是带来重复代码的原因）</li> <li>虽然我们会想到 trait 方法的默认实现，但这是有限制的，例如无法直接返回 <code>self</code> ，这不得不导致各个 trait 对象实现冗余代码</li></ol></li></ul></li> <li><p>将各个状态实现为不同的类型（<em><strong>type</strong></em>）：</p> <ul><li>为不同的状态设计不同的类型</li> <li>因此，不同的状态所能调用的方法也是不同的</li> <li>所以，若调用了某个状态所不具备的方法，编译器会给出错误提示</li></ul></li></ul> <h2 id="场景"><a href="#场景" class="header-anchor">#</a> 场景</h2> <p>考虑一个发布 blog 的方案，设计为不同的状态：</p> <ul><li>【草稿状态】Draft
<ul><li>可以增加文本</li> <li>请求审核后进入审核状态</li></ul></li> <li>【审核状态】PendingReview
<ul><li>可以回退到草稿状态</li> <li>两次请求发布后进入发布状态</li></ul></li> <li>【发布状态】Published
<ul><li>能够获得 blog 内容</li> <li>不能切换到其它状态</li></ul></li></ul> <h2 id="实现-trait-object"><a href="#实现-trait-object" class="header-anchor">#</a> 实现 - <em>trait object</em></h2> <h3 id="定义-trait"><a href="#定义-trait" class="header-anchor">#</a> 定义 <em>trait</em></h3> <p>抽象出如下方法：</p> <ol><li>增加文本，只有文稿状态能够增加文本</li> <li>请求审核，进入审核状态</li> <li>拒绝审核，退回到文稿状态</li> <li>请求发布，进入发布状态</li> <li>获取内容，只有发布状态能够获得内容</li></ol> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> SOState <span class="token punctuation">{</span>
	<span class="token keyword">fn</span> <span class="token function">add_text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
	<span class="token keyword">fn</span> <span class="token function">review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token keyword">fn</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>分别讲解：</p> <ul><li><code>add_text</code> <ul><li>涉及到文本内容改变，因此使用 <code>&amp;mut self</code></li> <li>该方法只会改变自身的内容，不会涉及到状态的切换</li> <li>由于只在文稿状态下能够改变内容，因此为该方法提供默认的空实现</li></ul></li> <li><code>review</code> &amp; <code>reject</code> &amp; <code>approve</code> <ul><li>这几个方法可能涉及到状态的切换，因此需要消费当前状态的所有权，即使用 <code>self</code></li> <li>并不是任何方法调用都会引起状态切换，例如在文稿状态调用 <code>approve</code> ，此时仍然是在文稿状态，也就是仍然返回自身，即 <code>self</code> ；甚至对每个状态来说，大多数的方法调用都是如此</li> <li>所以，对每个状态对象（即 trait 对象）来说，会存在很多冗余的方法实现，但我们也无法为该 trait 提供默认方法实现，因为我们无法在 trait 方法中直接返回 <code>self</code> ，否则编译器会提示「无法确定 <code>self</code> 的空间大小」</li> <li>使用 <code>self: Box&lt;Self&gt;</code> 语法的目的，是为了让 rust 自动为我们完成从  <code>self</code> 到 <code>Box&lt;Self&gt;</code> 的装箱过程，这样做的好处是，如果方法实现是直接返回自身，则可以直接返回 <code>self</code> ，就能得到 <code>Box&lt;dyn SOState&gt;</code> 这样的 trait 对象</li> <li>当然，不使用 <code>self: Box&lt;Self&gt;</code> 这样的修饰也是可以的，参数直接为 <code>self</code> ，那么在需要返回自身时，为了符合 <code>Box&lt;dyn SOState&gt;</code> 这样的返回值类型，就需要手动装箱，例如 <code>Box::new(self)</code></li></ul></li> <li><code>content</code> <ul><li>该方法获取文稿内容，只在发布状态下有用</li> <li>因此为该方法提供默认的实现，返回空的内容</li></ul></li></ul> <h3 id="文稿状态"><a href="#文稿状态" class="header-anchor">#</a> 文稿状态</h3> <p>定义对应的 struct ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> SODraft <span class="token punctuation">{</span>
    <span class="token comment">// 保存文本内容</span>
	content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后实现 trait ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> SOState <span class="token keyword">for</span> SODraft <span class="token punctuation">{</span>
    <span class="token comment">// 增加文本</span>
	<span class="token keyword">fn</span> <span class="token function">add_text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 请求审核后，切换到审核状态</span>
	<span class="token keyword">fn</span> <span class="token function">review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
			SOPendingReview <span class="token punctuation">{</span>
				content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
				approve_count<span class="token punctuation">:</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">fn</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">self</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">self</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>剖析：</p> <ol><li><p>对文稿状态来说，只能增加文本，以及请求审核，即 <code>add_text</code> 和 <code>review</code> 方法</p></li> <li><p>关于 <code>review</code> 方法：</p> <ul><li>此时需要切换到审核状态，因此需要创建新的审核状态对象</li> <li>审核状态的 struct 定义后续会讲解</li></ul></li> <li><p>关于 <code>reject</code> 和 <code>approve</code> 方法：</p> <ul><li>在文稿状态，调用这两个方法都不应该引起状态切换</li> <li>因此，这两个方法调用后，仍然是返回当前状态，即 <code>self</code></li> <li>所以，这两个方法的实现是冗余的，但没有办法，因为 trait 方法的默认实现中，无法直接返回 <code>self</code></li> <li>对于后续的状态，也会存在这样的冗余，因此后续的状态里，这些冗余的方法代码不再复制到本书中</li></ul></li> <li><p><em><strong>关于所有权</strong></em>：</p> <ul><li>可以看到有的方法参数是 <code>self</code> ，即当前状态的所有权被转移到了方法中</li> <li>如果方法仍然返回当前状态，即返回 <code>self</code> ，则当前状态的所有权又从该方法转移给调用者，也就是说，只是同一个状态的所有权发生了几次转移，并没有额外的状态创建、状态销毁等操作</li> <li>如果方法需要返回新的状态，则创建新的状态并返回，而当前状态的生存周期在该方法结束后就已终止，从而被 rust 自动销毁</li></ul></li></ol> <h3 id="审核状态"><a href="#审核状态" class="header-anchor">#</a> 审核状态</h3> <p>定义审核状态的 struct ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> SOPendingReview <span class="token punctuation">{</span>
	content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
	approve_count<span class="token punctuation">:</span> RefCell<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>剖析：</p> <ol><li>后续每个状态都会有 <code>content</code> 成员，用来保存文稿数据：
<ul><li>虽然只有发布状态才能获得文稿数据，但文稿数据又是在文稿状态添加进去的</li> <li>而每个状态又是逐渐递进转换的，所以为了将文稿数据的内容最终传递到发布状态，就需要中间的每个状态都可以存储文稿数据</li> <li>而要特别说明的是，文稿数据内容可能很多，但将文稿数据从上一个状态传递给下一个状态时，并不需要文稿数据的克隆或深度拷贝</li> <li>因为每个状态的方法调用都是用 <code>self</code> 传递的，所以要将文稿数据传递给下一个状态时，直接将 <code>content</code> 的所有权传递给下一个状态即可</li> <li>所以，在前面文稿状态里，<code>review</code> 方法需要转换到审核状态，所以创建了新的审核状态对象，就是直接将 <code>content</code> 所有权传递给了审核状态，即 <code>content: self.content</code></li></ul></li> <li>关于 <code>approve_count</code> 成员：
<ul><li>根据场景描述，在审核状态下，需要两次请求发布，才能进入到发布状态</li> <li>因此，需要该成员来记录已请求发布的次数</li> <li>但 <code>approve</code> 方法的参数是 <code>self</code> ，而不是 <code>mut self</code> ，所以需要用 <code>RefCell</code> 来保存该成员</li></ul></li></ol> <p>然后为审核状态实现 trait ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> SOState <span class="token keyword">for</span> SOPendingReview <span class="token punctuation">{</span>
    <span class="token comment">// add_text 使用 trait 的默认实现</span>
    <span class="token comment">// review 方法不产生状态切换</span>

    <span class="token comment">// 退回到文稿状态，会产生状态切换</span>
	<span class="token keyword">fn</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
			SODraft <span class="token punctuation">{</span>
				content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 需要请求发布两次，才切换到发布状态</span>
	<span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>approve_count<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>approve_count<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
			Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
				SOPublished <span class="token punctuation">{</span>
					content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">self</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>剖析：</p> <ol><li><p><code>reject</code> 会产生状态切换，就是切换到文稿状态：</p> <ul><li>创建新的文稿状态，而当前审核状态被方法结束后被销毁</li> <li>同时 <code>content</code> 所有权直接转移给文稿状态</li></ul></li> <li><p><code>approve</code> 需要增加和判断请求发布的次数：</p> <ul><li>若请求发布的次数达到两次，则切换到发布状态，对应的，<code>content</code> 的所有权也是直接转移给发布状态</li> <li>若请求发布的次数未达到两次，则依然停留在审核状态，直接返回 <code>self</code></li></ul></li></ol> <h3 id="发布状态"><a href="#发布状态" class="header-anchor">#</a> 发布状态</h3> <p>发布状态只需要保存文稿数据：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> SOPublished <span class="token punctuation">{</span>
	content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后为发布状态实现 trait ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> SOState <span class="token keyword">for</span> SOPublished <span class="token punctuation">{</span>
    <span class="token comment">// add_text 使用 trait 的默认实现</span>
    <span class="token comment">// review/reject/approve 方法不产生状态切换</span>

    <span class="token comment">// 只有审核状态才能获取文稿内容</span>
	<span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
		<span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>content
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>剖析：</p> <ol><li>对于发布状态来说，唯一的功能就是获取文稿内容</li> <li>因此从文稿状态开始的 <code>content</code> 数据，所有权最终被传递给发布状态</li></ol> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <p>现在考虑如何使用上述状态：</p> <ul><li>需要新建一个文稿，也就是得到了初始状态（文稿状态）</li> <li>得到初始状态以后，就可以调用不同的方法</li> <li>不同方法的调用可能会产生新的状态切换，但对使用者来说这个切换过程是透明的</li></ul> <p>因此，我们还需要提供一个建立初始状态的方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">so_init_blog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> SOState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
		SODraft <span class="token punctuation">{</span>
			content<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>剖析：</p> <ol><li>该方法建立新的文稿，返回初始状态</li> <li>所以，该方法返回一个文稿状态对象，文稿内容初始为空</li> <li>得到初始状态后，使用者只关注 trait 所提供的方法，而不关注后续的状态切换</li></ol> <h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <p>根据场景需求，可以编写不同的测试，例如对审核状态回退到文稿状态进行测试：</p> <ol><li>新建文稿，并增加内容 A（文稿状态，内容 A 可以被添加）</li> <li>审核文稿，并增加内容 B（在审核状态下，内容 B 实际上不会被添加）</li> <li>回退文稿，并增加内容 C（回退到文稿状态，内容 C 可以被添加）</li> <li>审核文稿，并两次请求发布</li> <li>此时进入了发布状态，可以获取到文稿内容 A + C</li></ol> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> so_test <span class="token punctuation">{</span>
	<span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

	<span class="token attribute attr-name">#[test]</span>
	<span class="token keyword">fn</span> <span class="token function">test_review_to_reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化文稿并添加数据 A</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> <span class="token function">so_init_blog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		b<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">&quot;test blog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 审核文稿并添加数据 B</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		b<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">&quot;[can not add text]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 回退文稿并添加数据 C</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		b<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">&quot; [add text after reject]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 审核并两次请求发布</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 此时能获取到文稿数据 A + C</span>
		<span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;test blog [add text after reject]&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><blockquote><p>更多的测试请参考源代码</p></blockquote> <h2 id="实现-type"><a href="#实现-type" class="header-anchor">#</a> 实现 - <em>type</em></h2> <p>说明：</p> <ul><li>这种方式不再定义 trait ，也不再使用 trait object</li> <li>而是将各个状态定义为不同的类型（例如 struct）</li> <li>每个状态能够提供的方法都可能不同，但都只提供当前状态可以调用的方法</li></ul> <h3 id="文稿状态-2"><a href="#文稿状态-2" class="header-anchor">#</a> 文稿状态</h3> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 文稿状态</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> STDraft <span class="token punctuation">{</span>
	content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> STDraft <span class="token punctuation">{</span>
	<span class="token comment">/// 增加文本</span>
	<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add_text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/// 请求审核，进入审核状态</span>
	<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> STPendingReview <span class="token punctuation">{</span>
		STPendingReview <span class="token punctuation">{</span>
			content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
			approve_count<span class="token punctuation">:</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>剖析：</p> <ul><li><code>add_text</code> 方法没什么不同，仍然是 <code>&amp;mut self</code> ，并将内容增加到 <code>content</code> 中</li> <li><code>review</code> 会产生新的状态切换，所以参数是 <code>self</code> ：
<ul><li>我们不再返回 trait 对象，而是直接返回下一个新的状态类型，因此返回值直接是 <code>STPendingReview</code></li> <li>对应的，没有必要再对 <code>self</code> 进行装箱，所以不需要修饰为 <code>Box&lt;Self&gt;</code></li> <li>同时，<code>content</code> 的所有权直接传递给新的审核状态，对后续的其它状态也是如此</li></ul></li></ul> <h3 id="审核状态-2"><a href="#审核状态-2" class="header-anchor">#</a> 审核状态</h3> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 审核状态</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> STPendingReview <span class="token punctuation">{</span>
	content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
	approve_count<span class="token punctuation">:</span> RefCell<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> STPendingReview <span class="token punctuation">{</span>
	<span class="token comment">/// 退回文稿，回到文稿状态</span>
	<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> STDraft <span class="token punctuation">{</span>
		STDraft <span class="token punctuation">{</span>
			content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/// 两次请求发布，进入发布状态，否则仍然停留在审核状态</span>
	<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>STPublished<span class="token punctuation">,</span> STPendingReview<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>approve_count<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>approve_count<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
			<span class="token function">Ok</span><span class="token punctuation">(</span>
				STPublished <span class="token punctuation">{</span>
					content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">Err</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>剖析：</p> <ul><li><code>reject</code> <ul><li>在审核状态可以退回文稿状态，因此消费 <code>self</code></li> <li>同时，<code>content</code> 的所有权直接传递给新的审核状态，对后续的其它状态也是如此</li></ul></li> <li><code>approve</code> <ul><li>该方法有点特殊，因为需要请求发布两次，才能进入发布状态</li> <li>因此，该方法可能返回两种状态：一种是停留在当前审核状态，一种是切换到发布状态</li> <li>所以，使用了 <code>Result&lt;T, E&gt;</code> 返回值，在成功切换到发布状态时，返回 <code>Ok(T)</code> ，即 <code>STPublished</code> ；若请求发布失败，则停留在当前状态，返回 <code>Err(E)</code> ，即 <code>STPendingReview</code> ，也就是 <code>self</code></li></ul></li></ul> <h3 id="发布状态-2"><a href="#发布状态-2" class="header-anchor">#</a> 发布状态</h3> <p>发布状态比较简单，代码如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 发布状态</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> STPublished <span class="token punctuation">{</span>
	content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> STPublished <span class="token punctuation">{</span>
	<span class="token comment">/// 获取文稿数据</span>
	<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
		<span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>content
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="使用-2"><a href="#使用-2" class="header-anchor">#</a> 使用</h3> <p>对应的，提供一个建立初始状态的方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">st_init_blog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> STDraft <span class="token punctuation">{</span>
	STDraft <span class="token punctuation">{</span>
		content<span class="token punctuation">:</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>剖析：</p> <ul><li>初始状态就是文稿状态</li> <li>不适用 trait 对象，因此直接返回文稿状态对应的类型，即 <code>STDraft</code></li></ul> <h3 id="测试-2"><a href="#测试-2" class="header-anchor">#</a> 测试</h3> <p>类似的，测试整个流程，注意看注释：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> st_test <span class="token punctuation">{</span>
	<span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

	<span class="token attribute attr-name">#[test]</span>
	<span class="token keyword">fn</span> <span class="token function">from_draft_to_published</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化文稿</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> <span class="token function">st_init_blog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		b<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">&quot;test blog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 审核文稿</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 退回文稿后增加文稿内容</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		b<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">&quot; [add text after reject]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 重新审核文稿</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 第一次请求发布，会仍然停留在审核状态</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 第二次请求发布，会进入审核状态</span>
		<span class="token keyword">let</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在审核状态获取文稿内容</span>
		<span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;test blog [add text after reject]&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>状态模式的优缺点总结：</p> <ul><li>每个状态负责自身的行为规则，并负责切换到下一个状态</li> <li>对使用者来说，不关心每个状态的行为有何不同，也不关心状态何时发生的切换</li> <li>当业务规则变化时，只需要增加新的状态，或者修改某个状态的内部代码</li> <li>如果不使用状态模式，则操作逻辑的判断需要很多的 <code>if</code> 或 <code>match</code> ，代码会变得更耦合，且不易阅读</li> <li>但缺点是，状态之间相互联系，增加新的状态时，原有的某些状态切换代码需要修改</li></ul> <p>状态模式的实现总结：</p> <ul><li>可以使用 trait 对象：
<ul><li>使用者得到的类型统一，都是同一种 trait 对象</li> <li>即使状态切换，也是同一种 trait 对象</li> <li><em><strong>当一个方法可能返回 A 状态或者 B 状态时，使用 trait 对象就非常灵活</strong></em></li> <li>但缺点是，各种状态内部可能存在冗余方法</li></ul></li> <li>可以将不同状态实现为不同的类型
<ul><li>使用者得到的类型不统一</li> <li>但是每种类型能够调用的方法是明确的</li> <li>从上面的例子可以看到，<em><strong>如果某个方法可能返回 A 状态或者 B 状态时，对状态的实现者、以及对状态的使用者，都是非常不方便的</strong></em>，尤其使用者来说，需要额外的代码和逻辑来区分到底返回的是 A 状态还是 B 状态</li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/15/2020, 7:29:49 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Rust/Rust_Book_Exp/17 Object Oriented Programming Features of Rust/02 Using Trait Objects That Allow for Values of Different Types.html" class="prev">
        17.2. Trait 对象
      </a></span> <span class="next"><a href="/Rust/Rust_Book_Exp/18 Patterns and Matching/01 All the Places Patterns Can Be Used.html">
        18.1. 何时使用模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b639eb72.js" defer></script><script src="/assets/js/2.5df156af.js" defer></script><script src="/assets/js/86.47c806cb.js" defer></script>
  </body>
</html>
