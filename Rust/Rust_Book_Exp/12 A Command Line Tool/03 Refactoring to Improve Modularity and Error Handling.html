<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>12.3. 重构代码 | Lindorof</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Lindorof's Blog">
    <link rel="preload" href="/assets/css/0.styles.8ac2847d.css" as="style"><link rel="preload" href="/assets/js/app.b639eb72.js" as="script"><link rel="preload" href="/assets/js/2.5df156af.js" as="script"><link rel="preload" href="/assets/js/63.a6b6d595.js" as="script"><link rel="prefetch" href="/assets/js/10.ee4568ff.js"><link rel="prefetch" href="/assets/js/11.8db0767a.js"><link rel="prefetch" href="/assets/js/12.92a4e660.js"><link rel="prefetch" href="/assets/js/13.e2450b62.js"><link rel="prefetch" href="/assets/js/14.5ae14743.js"><link rel="prefetch" href="/assets/js/15.62a967cf.js"><link rel="prefetch" href="/assets/js/16.3482df63.js"><link rel="prefetch" href="/assets/js/17.881a9d91.js"><link rel="prefetch" href="/assets/js/18.d6e19ee5.js"><link rel="prefetch" href="/assets/js/19.caf0829a.js"><link rel="prefetch" href="/assets/js/20.a80e123c.js"><link rel="prefetch" href="/assets/js/21.9c810086.js"><link rel="prefetch" href="/assets/js/22.bc5f69cb.js"><link rel="prefetch" href="/assets/js/23.f15ef55d.js"><link rel="prefetch" href="/assets/js/24.b8714e3e.js"><link rel="prefetch" href="/assets/js/25.d673c092.js"><link rel="prefetch" href="/assets/js/26.28d57b84.js"><link rel="prefetch" href="/assets/js/27.d8b15b76.js"><link rel="prefetch" href="/assets/js/28.2574be13.js"><link rel="prefetch" href="/assets/js/29.54667d47.js"><link rel="prefetch" href="/assets/js/3.f6602695.js"><link rel="prefetch" href="/assets/js/30.dd697263.js"><link rel="prefetch" href="/assets/js/31.aafbc8db.js"><link rel="prefetch" href="/assets/js/32.5fe2531d.js"><link rel="prefetch" href="/assets/js/33.c3dfca3c.js"><link rel="prefetch" href="/assets/js/34.22613e38.js"><link rel="prefetch" href="/assets/js/35.aad9af2b.js"><link rel="prefetch" href="/assets/js/36.badbd522.js"><link rel="prefetch" href="/assets/js/37.45905373.js"><link rel="prefetch" href="/assets/js/38.ab0de43e.js"><link rel="prefetch" href="/assets/js/39.d1a7492c.js"><link rel="prefetch" href="/assets/js/4.c7710dca.js"><link rel="prefetch" href="/assets/js/40.92c4cb14.js"><link rel="prefetch" href="/assets/js/41.cc19be50.js"><link rel="prefetch" href="/assets/js/42.c9b4b585.js"><link rel="prefetch" href="/assets/js/43.1af966c8.js"><link rel="prefetch" href="/assets/js/44.40ebac1c.js"><link rel="prefetch" href="/assets/js/45.469b8553.js"><link rel="prefetch" href="/assets/js/46.eb491d21.js"><link rel="prefetch" href="/assets/js/47.03d1fbf2.js"><link rel="prefetch" href="/assets/js/48.af296c16.js"><link rel="prefetch" href="/assets/js/49.3a42b55b.js"><link rel="prefetch" href="/assets/js/5.339eb2f5.js"><link rel="prefetch" href="/assets/js/50.ef35a161.js"><link rel="prefetch" href="/assets/js/51.284d50de.js"><link rel="prefetch" href="/assets/js/52.c4983004.js"><link rel="prefetch" href="/assets/js/53.83c193e1.js"><link rel="prefetch" href="/assets/js/54.08f26cd6.js"><link rel="prefetch" href="/assets/js/55.ef20313b.js"><link rel="prefetch" href="/assets/js/56.dc2772cf.js"><link rel="prefetch" href="/assets/js/57.add26447.js"><link rel="prefetch" href="/assets/js/58.ff8f2704.js"><link rel="prefetch" href="/assets/js/59.43fdbc04.js"><link rel="prefetch" href="/assets/js/6.0ce72a94.js"><link rel="prefetch" href="/assets/js/60.1a27c7c3.js"><link rel="prefetch" href="/assets/js/61.9ca63ff6.js"><link rel="prefetch" href="/assets/js/62.9ab09b12.js"><link rel="prefetch" href="/assets/js/64.5e9ac56b.js"><link rel="prefetch" href="/assets/js/65.bcfb6015.js"><link rel="prefetch" href="/assets/js/66.5024eb22.js"><link rel="prefetch" href="/assets/js/67.5d83f99f.js"><link rel="prefetch" href="/assets/js/68.80f05874.js"><link rel="prefetch" href="/assets/js/69.6f9ff293.js"><link rel="prefetch" href="/assets/js/7.726c7fbf.js"><link rel="prefetch" href="/assets/js/70.92b749fb.js"><link rel="prefetch" href="/assets/js/71.a4248217.js"><link rel="prefetch" href="/assets/js/72.29aeb940.js"><link rel="prefetch" href="/assets/js/73.8918e90b.js"><link rel="prefetch" href="/assets/js/74.81fd32da.js"><link rel="prefetch" href="/assets/js/75.5357ccc2.js"><link rel="prefetch" href="/assets/js/76.66fc1725.js"><link rel="prefetch" href="/assets/js/77.6f29512b.js"><link rel="prefetch" href="/assets/js/78.a63871cd.js"><link rel="prefetch" href="/assets/js/79.c646997c.js"><link rel="prefetch" href="/assets/js/8.81d630fc.js"><link rel="prefetch" href="/assets/js/80.b5d5ad39.js"><link rel="prefetch" href="/assets/js/81.601aa569.js"><link rel="prefetch" href="/assets/js/82.99bc0640.js"><link rel="prefetch" href="/assets/js/83.06d4defc.js"><link rel="prefetch" href="/assets/js/84.44856307.js"><link rel="prefetch" href="/assets/js/85.3b88ee80.js"><link rel="prefetch" href="/assets/js/86.47c806cb.js"><link rel="prefetch" href="/assets/js/87.b5201cdf.js"><link rel="prefetch" href="/assets/js/88.f9ce8655.js"><link rel="prefetch" href="/assets/js/89.c1f12bf1.js"><link rel="prefetch" href="/assets/js/9.b6118830.js"><link rel="prefetch" href="/assets/js/90.e0f850a2.js"><link rel="prefetch" href="/assets/js/91.8166ca11.js"><link rel="prefetch" href="/assets/js/92.6ba6ce27.js"><link rel="prefetch" href="/assets/js/93.6e09fb58.js"><link rel="prefetch" href="/assets/js/94.1b324565.js"><link rel="prefetch" href="/assets/js/95.5308659f.js"><link rel="prefetch" href="/assets/js/96.306bee11.js"><link rel="prefetch" href="/assets/js/97.6e231fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ac2847d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Lindorof" class="logo"> <span class="site-name can-hide">Lindorof</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Rust/Rust_Book_Exp/" aria-current="page" class="sidebar-link">「RustBook」学习心得</a></li><li><a href="/Rust/Rust_Book_Exp/01 Getting Started/01 Getting Started.html" class="sidebar-link">1. 开始</a></li><li><a href="/Rust/Rust_Book_Exp/02 Programming a Guessing Game/01 Programming a Guessing Game.html" class="sidebar-link">2. 猜谜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3. 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>4. 所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>5. 结构体</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>6. 枚举</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>7. 模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>8. 集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>9. 错误处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>10. 泛型及生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>11. 自动测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>12. 命令行</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/00 Foreword.html" class="sidebar-link">12.0. 前言</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/01 Accepting Command Line Arguments.html" class="sidebar-link">12.1. 命令行参数</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/02 Reading a File.html" class="sidebar-link">12.2. 读文件</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/03 Refactoring to Improve Modularity and Error Handling.html" class="active sidebar-link">12.3. 重构代码</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/04 Test Driven Development.html" class="sidebar-link">12.4. tdd 开发模式</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/05 Working with Environment Variables.html" class="sidebar-link">12.5. 环境变量</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/06 Standard Output and Standard Error.html" class="sidebar-link">12.6. stdout &amp; stderr</a></li><li><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/07 Appendix.html" class="sidebar-link">12.7. 附：源码结构</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>13. 闭包及迭代器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>14. Cargo 和 Crates.io</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>15. 智能指针</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>16. 无畏并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>17. 面向对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>18. 模式与匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>19. 高级特征</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_12-3-重构代码"><a href="#_12-3-重构代码" class="header-anchor">#</a> 12.3. 重构代码</h1> <p>当前该程序能够完成我们预期的功能，但是存在如下几方面问题：</p> <ol><li><code>main</code> 函数中同时在处理多件事情：解析参数、文件读取等，随着函数功能的增加，<code>main</code> 函数中的代码会变得庞大且不容易阅读和维护。因此，<strong>需要按照功能来分解为多个函数，每个函数独立处理一件事情</strong></li> <li>函数中涉及到多个变量，例如命令行参数也就是配置数据 <code>query</code> 和 <code>filename</code> ，即 <code>args[1]</code> 和 <code>args[2]</code> ，同时，还有文件内容即 <code>contents</code> 这种变量，随着函数功能的增加，变量也会越来越多，且越来越不容易理解各个变量的用途。因此，<strong>对于多个配置数据，需要封装在 <code>struct</code> 中，从而让这些数据的用途更清晰</strong></li> <li>读取文件内容时，使用了 <code>expect</code> ，所以在遇到错误时，打印出来的错误提示对用户来说没有任何意义。因此，<strong>需要处理具体的错误类型</strong></li> <li>代码中多个地方可能发生错误，但是处理方式和提示信息凌乱。因此，<strong>需要将错误处理集中在一个地方统一处理，从而，只需要在一个地方统一更改错误处理逻辑，且能够输出更人性化的错误提示信息</strong></li></ol> <h3 id="binary-project-功能划分原则"><a href="#binary-project-功能划分原则" class="header-anchor">#</a> Binary Project 功能划分原则</h3> <p>大多数 Binary Project 都面临如何划分功能并提供给 <code>main</code> 函数使用的问题，因此，rust 社区制定了一套划分原则，这套原则包括下面几大方面：</p> <h5 id="需要从-main-中分离的功能"><a href="#需要从-main-中分离的功能" class="header-anchor">#</a> 需要从 <code>main</code> 中分离的功能</h5> <ul><li>将程序划分为 <code>main.rs</code> 和 <code>lib.rs</code> ，并将程序的逻辑放在 <code>lib.rs</code> 中</li> <li>如果命令行参数处理逻辑很简单，则可以由 <code>main.rs</code> 来处理</li> <li>如果命令行参数处理逻辑复杂，则放到 <code>lib.rs</code> 中处理</li></ul> <h5 id="保留在-main-中的功能"><a href="#保留在-main-中的功能" class="header-anchor">#</a> 保留在 <code>main</code> 中的功能</h5> <ul><li>调用命令行参数的处理逻辑，来解析命令行参数</li> <li>建立其它配置信息</li> <li>调用 <code>lib.rs</code> 中的 <code>run</code> 函数</li> <li>处理 <code>run</code> 函数的成功/错误情况</li></ul> <h5 id="可测试原则"><a href="#可测试原则" class="header-anchor">#</a> 可测试原则</h5> <ul><li><code>lib.rs</code> 中的功能可以编写函数来直接测试</li> <li>但是，<code>main</code> 函数无法直接被测试</li> <li>因此，按照上述划分原则，***<code>main</code> 函数需要足够小，小到可以通过阅读代码来确认正确性***</li></ul> <h3 id="步骤一：参数处理和抽象"><a href="#步骤一：参数处理和抽象" class="header-anchor">#</a> 步骤一：参数处理和抽象</h3> <p>原则：</p> <ol><li><code>main</code> 函数只负责收集命令行参数</li> <li>而对命令行参数的处理和解析，交给独立的函数来完成</li> <li>最后，<code>main</code> 函数只关心得到的最终参数和参数的意义，而不关于类似上面代码中的参数顺序，例如 <code>args[1]</code> 和 <code>args[2]</code></li></ol> <h5 id="独立的参数解析逻辑"><a href="#独立的参数解析逻辑" class="header-anchor">#</a> 独立的参数解析逻辑</h5> <ul><li>将参数解析放到独立的函数中</li> <li>使用 tuple 来存储所需的两个参数</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>env<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> args<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> env<span class="token punctuation">::</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> <span class="token punctuation">(</span>query<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">parse_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} - {}&quot;</span><span class="token punctuation">,</span> query<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">parse_config</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">,</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h5 id="整合配置信息"><a href="#整合配置信息" class="header-anchor">#</a> 整合配置信息</h5> <ul><li>上面通过 parse_config 函数来返回一个 tuple，但紧接着在 main 函数中又被解构，变成了独立的变量，这说明我们还没有对这些配置数据进行正确的抽象和封装</li> <li>这两个数据 query 和 filename 都属于配置信息的一部分，因此应当组合在一个 struct 中，这样代码维护者可以清晰的看到这些数据的关系，以及这些数据的作用是什么</li></ul> <blockquote><p>对于某些场景，使用复杂类型（例如 struct ）是更合适的，但这个时候却使用大量的分散的原始数类型，从而导致数据分散，参数凌乱，这种行为就是 <em><strong>++anti-parttern++</strong></em> ，术语叫做 <em><strong>++primitive obsession++</strong></em></p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>env<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> args<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> env<span class="token punctuation">::</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cfg <span class="token operator">=</span> <span class="token function">parse_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} - {}&quot;</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>query<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> Config <span class="token punctuation">{</span>
    query<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    filename<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">parse_config</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Config <span class="token punctuation">{</span>
    Config <span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>对于使用 <code>clone</code> 的权衡：</p> <ul><li><code>env::args().collect()</code> 得到的是 collection ，因此，<code>args[1]</code> 得到的 <code>String</code> 只是 borrow，无法 move 给 struct 中的变量</li> <li>而如果将 struct 中的变量声明为引用，则需要管理 lifetime，对于本例子来说太过复杂</li> <li>因此，对于本例来说，直接使用 <code>clone</code> 是最简单的方式，因为这两个数据的内容不会很长，且只需要 <code>clone</code> 一次，所以，牺牲一定的性能，但带来程序的简化，这样的取舍是值得的</li></ul> <h5 id="使用-constructor-构建配置信息"><a href="#使用-constructor-构建配置信息" class="header-anchor">#</a> 使用 Constructor 构建配置信息</h5> <ul><li><code>parse_config</code> 函数的作用是创建 <code>Config</code> 这个 struct 的实例</li> <li>因此，可以直接为 <code>Config</code> 创建一个 Constructor ，例如 <code>new</code> ，则可以使用 <code>Config::new</code> 的方式来创建，这样的代码更符合阅读习惯</li> <li>但注意，虽然说是 Constructor ，本质上仍然是 struct 的 function</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>env<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> args<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> env<span class="token punctuation">::</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cfg <span class="token operator">=</span> Config<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} - {}&quot;</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>query<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> Config <span class="token punctuation">{</span>
    query<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    filename<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Config <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Config <span class="token punctuation">{</span>
        Config <span class="token punctuation">{</span>
            query<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            filename<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h5 id="优化错误提示"><a href="#优化错误提示" class="header-anchor">#</a> 优化错误提示</h5> <ul><li>代码中我们直接使用了 <code>args[1]</code> 和 <code>args[2]</code></li> <li>而如果命令行参数不够，则程序 panic</li> <li>且提示的错误信息是 <code>index out of bounds</code> ，即下标越界</li> <li>这样的错误提示是 rust 自身给出的，并不是我们自定义的，而且这样的提示信息会让用户很费解，无法理解真正的问题原因</li></ul> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

thread 'main' panicked at 'index out of bounds ...'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因此需要对参数进行校验，并使用自定义的错误提示信息：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Config <span class="token punctuation">{</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
        <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;not enough args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此时错误提示如下：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

thread 'main' panicked at 'not enough args' ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="使用-result-而不是-panic"><a href="#使用-result-而不是-panic" class="header-anchor">#</a> 使用 <code>Result</code> 而不是 <code>panic!</code></h5> <ul><li>在 <code>new</code> 中，使用 <code>Result</code> 来返回结果</li> <li>而在 <code>main</code> 函数中来处理 <code>Result</code> ，从而由 <code>main</code> 函数决定如何处理错误</li> <li>对应的，可以使用 <code>process::exit()</code> 来替代 <code>panic!</code> ，避免 rust 的一些额外的错误提示信息，例如 <code>thread 'main' panicked at ...</code> 这种内容</li></ul> <p>首先更改 <code>new</code> 函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>Config<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span>String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;not enough args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span>Config <span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>对于 <code>Err</code> 中的字符串，也可以使用 <code>'static</code> ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>Config<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">&quot;not enough args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后，<code>main</code> 函数中进行错误处理：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> args<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> env<span class="token punctuation">::</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cfg <span class="token operator">=</span> Config<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>err<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;problem parsing args : {}&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">::</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} - {}&quot;</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>query<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p><code>process::exit()</code> 会立即停止程序，并返回参数指定的状态码，在该例子中我们传入的状态码是 1 。这与 <code>panic!</code> 类似，但区别是，<code>process::exit()</code> 不会出现额外的 rust 的错误提示信息</p></blockquote> <p>此时运行程序得到的错误提示如下：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

problem parsing args : not enough args
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="步骤二：将逻辑代码进行分离"><a href="#步骤二：将逻辑代码进行分离" class="header-anchor">#</a> 步骤二：将逻辑代码进行分离</h3> <p>目标：</p> <ol><li>将逻辑代码分离到一个 <code>run</code> 函数中</li> <li>同时，<code>main</code> 函数中只负责进行配置信息的构建和统一的错误处理</li> <li>从而，<code>main</code> 的代码就变得很精简，所完成的功能也很明确</li> <li>因此，逻辑代码可以通过编写测试函数来进行验证，而 <code>main</code> 函数的代码则很容易通过阅读检查来确认正确性</li></ol> <h5 id="分离逻辑代码到-run"><a href="#分离逻辑代码到-run" class="header-anchor">#</a> 分离逻辑代码到 <code>run</code></h5> <p><code>run</code> 函数代码如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span>cfg<span class="token punctuation">:</span> Config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> contents <span class="token operator">=</span> fs<span class="token punctuation">::</span><span class="token function">read_to_string</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;sth wrong reading file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对应的，<code>main</code> 调用如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//--snip--</span>
    
    <span class="token function">run</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="改进-run-的错误处理"><a href="#改进-run-的错误处理" class="header-anchor">#</a> 改进 <code>run</code> 的错误处理</h5> <ul><li>目前在 <code>run</code> 中使用了 <code>expect</code> ，因此遇到错误时，程序会 panic</li> <li>而我们希望错误处理统一集中在 main 函数中</li> <li>因此， 当 <code>run</code> 遇到错误时，使用 <code>Result</code> 而不是 <code>panic!</code></li></ul> <p>更改 <code>run</code> 的返回值为 <code>Result</code> ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span>cfg<span class="token punctuation">:</span> Config<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> contents <span class="token operator">=</span> fs<span class="token punctuation">::</span><span class="token function">read_to_string</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>代码剖析：</p> <ul><li><code>run</code> 成功时并需要返回数据，因此使用了 <code>()</code> 类型</li> <li>因此成功时的返回值是 <code>Ok(())</code></li> <li><code>run</code> 遇到错误时，使用了 <code>Box&lt;dyn Error&gt;</code> 类型，这表示 <code>run</code> 会返回一种错误类型，且这种错误类型实现了 <code>Error</code> 这个 trait ，但是不需要指定具体是哪种错误类型</li> <li>另外，<code>Box&lt;dyn Error&gt;</code> 就是 <em><strong>trait object</strong></em> ，在 Chapter17 讲解</li> <li>最后，在 <code>fs::read_to_string</code> 时，我们不再使用 <code>expect</code> ，因为这会导致程序 panic ，而是直接使用 <code>?</code> 来返回对应的错误</li></ul> <p>然后在 <code>main</code> 函数中处理错误：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//--snip--</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;run error : {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">::</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>代码剖析：</p> <ul><li>当 <code>run</code> 执行成功时，我们不需要关注其返回值</li> <li>也就是说，我们仅仅关注 <code>run</code> 遇到错误时的处理</li> <li>因此，不需要使用 <code>unwrap_or_else</code> ，而是使用更简便的 <code>if let</code></li> <li>同时，与 <code>Cofig::new</code> 一样，对于 <code>run</code> 的错误，使用 <code>process::exit()</code> ，而不是 <code>panic!</code></li></ul> <h3 id="步骤三：将逻辑代码放到-lib-crate-中"><a href="#步骤三：将逻辑代码放到-lib-crate-中" class="header-anchor">#</a> 步骤三：将逻辑代码放到 lib crate 中</h3> <p>目标：</p> <ul><li>main 函数的内容放在 <code>main.rs</code> 中</li> <li>逻辑代码分离到 <code>lib.rs</code> 中</li></ul> <p><code>lib.rs</code> 的内容：</p> <ol><li><code>run</code> 函数的代码</li> <li><code>run</code> 函数涉及到的 <code>use</code></li> <li><code>Config</code> 的定义</li> <li><code>Config</code> 对应的方法，例如 <code>Config::new</code></li></ol> <blockquote><p><code>lib.rs</code></p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>error<span class="token punctuation">::</span>Error<span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Config <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> query<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> filename<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Config <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>Config<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> str<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//--snip--</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span>cfg<span class="token punctuation">:</span> Config<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//--snip--</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p><code>main.rs</code></p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>env<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>process<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//--snip--</span>

    <span class="token keyword">let</span> cfg <span class="token operator">=</span> minigrep<span class="token punctuation">::</span>Config<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span>
        <span class="token comment">//--snip--</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//--snip--</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> minigrep<span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//--snip--</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>代码剖析：</p> <ul><li>由于逻辑代码放在 <code>lib.rs</code> 中，因此，<code>lib.rs</code> 中的 item 就默认被 rust 理解为在 <code>minigrep</code> 这个 module 之中</li> <li>因此，<code>Config , Config.query , Config.filename , Config::new , run</code> 这些元素都必须使用 <code>pub</code> 修饰，否则在 main 函数中无法访问到这些 item</li> <li>对应的，在 main 函数中，需要访问 <code>lib.rs</code> 中的 item 时，都需要使用 <code>minigrep::</code> 前缀，当然，也可以使用 <code>use minigrep</code> 来做一定的简化</li></ul> <h3 id="总结：文件结构和代码逻辑结构"><a href="#总结：文件结构和代码逻辑结构" class="header-anchor">#</a> 总结：文件结构和代码逻辑结构</h3> <p>此时的文件结构是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>graph TD

PROJ{minigrep} --&gt; SRC{/src}
SRC --&gt; MN(main.rs)
SRC --&gt; LB(lib.rs)
PROJ --&gt; TGT{/target}
TGT --&gt; DEBUG{/debug}
DEBUG --&gt; EXE(minigrep)
PROJ --&gt; TXT(test.txt)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>而 module 及 item 结构是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>graph TD

MAIN(fn main) --&gt; MG{mod minigrep}
MG --&gt; CFG{pub struct Config}
MG --&gt; RUN(pub fn run)
CFG --&gt; FQ[pub fields]
CFG --&gt; NEW(pub fn new)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>查看错误提示：参数无效时</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

problem parsing args : not enough args
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看错误提示：文件不存在时</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run sth test.txt.notexist

sth - test.txt.notexist
run error : No such file or directory (os error 2)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看运行成功时的结果：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run sth test.txt

sth - test.txt
-- file content snip --
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/3/2019, 8:13:20 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/02 Reading a File.html" class="prev">
        12.2. 读文件
      </a></span> <span class="next"><a href="/Rust/Rust_Book_Exp/12 A Command Line Tool/04 Test Driven Development.html">
        12.4. tdd 开发模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b639eb72.js" defer></script><script src="/assets/js/2.5df156af.js" defer></script><script src="/assets/js/63.a6b6d595.js" defer></script>
  </body>
</html>
