<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>19.1. 不安全代码 | Lindorof</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Lindorof's Blog">
    <link rel="preload" href="/assets/css/0.styles.8ac2847d.css" as="style"><link rel="preload" href="/assets/js/app.b639eb72.js" as="script"><link rel="preload" href="/assets/js/2.5df156af.js" as="script"><link rel="preload" href="/assets/js/90.e0f850a2.js" as="script"><link rel="prefetch" href="/assets/js/10.ee4568ff.js"><link rel="prefetch" href="/assets/js/11.8db0767a.js"><link rel="prefetch" href="/assets/js/12.92a4e660.js"><link rel="prefetch" href="/assets/js/13.e2450b62.js"><link rel="prefetch" href="/assets/js/14.5ae14743.js"><link rel="prefetch" href="/assets/js/15.62a967cf.js"><link rel="prefetch" href="/assets/js/16.3482df63.js"><link rel="prefetch" href="/assets/js/17.881a9d91.js"><link rel="prefetch" href="/assets/js/18.d6e19ee5.js"><link rel="prefetch" href="/assets/js/19.caf0829a.js"><link rel="prefetch" href="/assets/js/20.a80e123c.js"><link rel="prefetch" href="/assets/js/21.9c810086.js"><link rel="prefetch" href="/assets/js/22.bc5f69cb.js"><link rel="prefetch" href="/assets/js/23.f15ef55d.js"><link rel="prefetch" href="/assets/js/24.b8714e3e.js"><link rel="prefetch" href="/assets/js/25.d673c092.js"><link rel="prefetch" href="/assets/js/26.28d57b84.js"><link rel="prefetch" href="/assets/js/27.d8b15b76.js"><link rel="prefetch" href="/assets/js/28.2574be13.js"><link rel="prefetch" href="/assets/js/29.54667d47.js"><link rel="prefetch" href="/assets/js/3.f6602695.js"><link rel="prefetch" href="/assets/js/30.dd697263.js"><link rel="prefetch" href="/assets/js/31.aafbc8db.js"><link rel="prefetch" href="/assets/js/32.5fe2531d.js"><link rel="prefetch" href="/assets/js/33.c3dfca3c.js"><link rel="prefetch" href="/assets/js/34.22613e38.js"><link rel="prefetch" href="/assets/js/35.aad9af2b.js"><link rel="prefetch" href="/assets/js/36.badbd522.js"><link rel="prefetch" href="/assets/js/37.45905373.js"><link rel="prefetch" href="/assets/js/38.ab0de43e.js"><link rel="prefetch" href="/assets/js/39.d1a7492c.js"><link rel="prefetch" href="/assets/js/4.c7710dca.js"><link rel="prefetch" href="/assets/js/40.92c4cb14.js"><link rel="prefetch" href="/assets/js/41.cc19be50.js"><link rel="prefetch" href="/assets/js/42.c9b4b585.js"><link rel="prefetch" href="/assets/js/43.1af966c8.js"><link rel="prefetch" href="/assets/js/44.40ebac1c.js"><link rel="prefetch" href="/assets/js/45.469b8553.js"><link rel="prefetch" href="/assets/js/46.eb491d21.js"><link rel="prefetch" href="/assets/js/47.03d1fbf2.js"><link rel="prefetch" href="/assets/js/48.af296c16.js"><link rel="prefetch" href="/assets/js/49.3a42b55b.js"><link rel="prefetch" href="/assets/js/5.339eb2f5.js"><link rel="prefetch" href="/assets/js/50.ef35a161.js"><link rel="prefetch" href="/assets/js/51.284d50de.js"><link rel="prefetch" href="/assets/js/52.c4983004.js"><link rel="prefetch" href="/assets/js/53.83c193e1.js"><link rel="prefetch" href="/assets/js/54.08f26cd6.js"><link rel="prefetch" href="/assets/js/55.ef20313b.js"><link rel="prefetch" href="/assets/js/56.dc2772cf.js"><link rel="prefetch" href="/assets/js/57.add26447.js"><link rel="prefetch" href="/assets/js/58.ff8f2704.js"><link rel="prefetch" href="/assets/js/59.43fdbc04.js"><link rel="prefetch" href="/assets/js/6.0ce72a94.js"><link rel="prefetch" href="/assets/js/60.1a27c7c3.js"><link rel="prefetch" href="/assets/js/61.9ca63ff6.js"><link rel="prefetch" href="/assets/js/62.9ab09b12.js"><link rel="prefetch" href="/assets/js/63.a6b6d595.js"><link rel="prefetch" href="/assets/js/64.5e9ac56b.js"><link rel="prefetch" href="/assets/js/65.bcfb6015.js"><link rel="prefetch" href="/assets/js/66.5024eb22.js"><link rel="prefetch" href="/assets/js/67.5d83f99f.js"><link rel="prefetch" href="/assets/js/68.80f05874.js"><link rel="prefetch" href="/assets/js/69.6f9ff293.js"><link rel="prefetch" href="/assets/js/7.726c7fbf.js"><link rel="prefetch" href="/assets/js/70.92b749fb.js"><link rel="prefetch" href="/assets/js/71.a4248217.js"><link rel="prefetch" href="/assets/js/72.29aeb940.js"><link rel="prefetch" href="/assets/js/73.8918e90b.js"><link rel="prefetch" href="/assets/js/74.81fd32da.js"><link rel="prefetch" href="/assets/js/75.5357ccc2.js"><link rel="prefetch" href="/assets/js/76.66fc1725.js"><link rel="prefetch" href="/assets/js/77.6f29512b.js"><link rel="prefetch" href="/assets/js/78.a63871cd.js"><link rel="prefetch" href="/assets/js/79.c646997c.js"><link rel="prefetch" href="/assets/js/8.81d630fc.js"><link rel="prefetch" href="/assets/js/80.b5d5ad39.js"><link rel="prefetch" href="/assets/js/81.601aa569.js"><link rel="prefetch" href="/assets/js/82.99bc0640.js"><link rel="prefetch" href="/assets/js/83.06d4defc.js"><link rel="prefetch" href="/assets/js/84.44856307.js"><link rel="prefetch" href="/assets/js/85.3b88ee80.js"><link rel="prefetch" href="/assets/js/86.47c806cb.js"><link rel="prefetch" href="/assets/js/87.b5201cdf.js"><link rel="prefetch" href="/assets/js/88.f9ce8655.js"><link rel="prefetch" href="/assets/js/89.c1f12bf1.js"><link rel="prefetch" href="/assets/js/9.b6118830.js"><link rel="prefetch" href="/assets/js/91.8166ca11.js"><link rel="prefetch" href="/assets/js/92.6ba6ce27.js"><link rel="prefetch" href="/assets/js/93.6e09fb58.js"><link rel="prefetch" href="/assets/js/94.1b324565.js"><link rel="prefetch" href="/assets/js/95.5308659f.js"><link rel="prefetch" href="/assets/js/96.306bee11.js"><link rel="prefetch" href="/assets/js/97.6e231fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ac2847d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Lindorof" class="logo"> <span class="site-name can-hide">Lindorof</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Rust/Rust_Book_Exp/" aria-current="page" class="sidebar-link">「RustBook」学习心得</a></li><li><a href="/Rust/Rust_Book_Exp/01 Getting Started/01 Getting Started.html" class="sidebar-link">1. 开始</a></li><li><a href="/Rust/Rust_Book_Exp/02 Programming a Guessing Game/01 Programming a Guessing Game.html" class="sidebar-link">2. 猜谜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3. 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>4. 所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>5. 结构体</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>6. 枚举</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>7. 模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>8. 集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>9. 错误处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>10. 泛型及生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>11. 自动测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>12. 命令行</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>13. 闭包及迭代器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>14. Cargo 和 Crates.io</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>15. 智能指针</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>16. 无畏并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>17. 面向对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>18. 模式与匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>19. 高级特征</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Rust/Rust_Book_Exp/19 Advanced Features/01 Unsafe Rust.html" class="active sidebar-link">19.1. 不安全代码</a></li><li><a href="/Rust/Rust_Book_Exp/19 Advanced Features/02 Advanced Traits.html" class="sidebar-link">19.2. 高级 trait</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_19-1-不安全代码"><a href="#_19-1-不安全代码" class="header-anchor">#</a> 19.1. 不安全代码</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <h3 id="关于-unsafe-rust"><a href="#关于-unsafe-rust" class="header-anchor">#</a> 关于 <em><strong>unsafe rust</strong></em></h3> <ul><li>rust 的编译（即静态分析）是保守的，它确保了程序执行时的内存安全，因为拒绝有效的程序总比接受无效的程序好</li> <li>但 rust 还有一个特性是 <em><strong>unsafe rust</strong></em> ，即 <em><strong>不安全代码</strong></em> ，关键字是 <code>unsafe</code> ，它让编译器放弃安全性检查，转而让程序员自己来保证，就像 C++ 一样，一切安全性保证都交给程序员</li> <li><em><strong>unsafe rust</strong></em> 存在的原因之一，是为了完成与操作系统和硬件的直接交互。如果放弃了这个特性，则无法完成底层系统编程，而这是 rust 的功能或目标之一</li> <li>注意，使用 <code>unsafe</code> 不代表对应的代码一定会带来内存安全问题，但相反，出现内存安全相关的错误时，必定与 <code>unsafe</code> 代码块有关，从而方便问题排查</li></ul> <h3 id="使用-unsafe-的场景"><a href="#使用-unsafe-的场景" class="header-anchor">#</a> 使用 <code>unsafe</code> 的场景</h3> <p>本文会依次讲解下面的场景：</p> <ul><li>解引用裸指针（<em><strong>raw pointer</strong></em>）</li> <li>调用不安全的函数或方法</li> <li>使用 <code>mut</code> 静态变量</li> <li>不安全的 trait</li> <li>访问 <code>union</code> 字段（本文未讲解）</li></ul> <h2 id="使用裸指针"><a href="#使用裸指针" class="header-anchor">#</a> 使用裸指针</h2> <h3 id="关于裸指针"><a href="#关于裸指针" class="header-anchor">#</a> 关于裸指针</h3> <ul><li>rust 编译器会确保引用总是有效的，但在 unsafe rust 中有***裸指针***（<em><strong>raw pointer</strong></em>）这种类似于引用的类型</li> <li>裸指针也分为两种：不可变的或可变的，即 <code>*const T</code> 和 <code>*mut T</code></li> <li>注意，裸指针的可变性指的是 <em><strong>解引用之后</strong></em> ，而不是指针本身，且可变性需要显式标注：不可变的显式标注为 <code>const</code> ，可变的显式标注为 <code>mut</code></li> <li>而裸指针本身也是 rust 的一种类型，对应的变量也存在可变和不可变，例如不可变的变量 <code>let r</code> ，可变的变量 <code>let mut r</code></li> <li>因此，变量本身的可变性，与裸指针解引用之后的可变性是不同的，这个概念需要区分开</li> <li>所以，设想一种情况：有不可变的变量 <code>let v</code> ，然后用一个可变的裸指针 <code>*mut</code> 指向 <code>v</code> ，此时 rust 是会给出编译错误提示的，后续会有例子讲解</li></ul> <h3 id="裸指针的特性"><a href="#裸指针的特性" class="header-anchor">#</a> 裸指针的特性</h3> <p>裸指针的特性，从裸指针与引用（或智能指针）的区别可以看到：</p> <ul><li>rust 会忽略借用规则，可同时拥有不可变和可变的裸指针，或者多个可变指针指向同一个位置</li> <li>rust 不会保证裸指针一定指向有效的内存，甚至指向空地址</li> <li>rust 不会为裸指针实现任何自动清理功能</li></ul> <h3 id="创建裸指针"><a href="#创建裸指针" class="header-anchor">#</a> 创建裸指针</h3> <p>需要注意的是：</p> <ul><li>创建裸指针并不需要 <code>unsafe</code> 关键字</li> <li>因为创建裸指针不会带来安全隐患</li> <li>解引用裸指针时（即访问指针指向的地址内容时）才会带来安全隐患，才需要使用 <code>unsafe</code> 关键字</li> <li>创建裸指针的语法参见下面的例子</li></ul> <blockquote><p>举例：同时创建多个不可变和可变的裸指针，在该例子中，指针指向的地址是有效的</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    创建一个mut变量，如果不使用 mut 修饰，
    则后续无法创建指向该变量的 *mut 指针
    */</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment">/*
    裸指针r1指向num
    使用 as 关键字来声明裸指针的类型
    注意：
    &amp; num 与 *const 的可变性对应
    */</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>
    <span class="token comment">/*
    裸指针r2指向num
    使用 as 关键字来声明裸指针的类型
    注意：
    &amp;mut num 与 *mut 的可变性对应
    */</span>
    <span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>

    <span class="token comment">/*
    再创建r3和r4，
    一个是 *const ，
    一个是 *mut ，
    从而，
    r1/r2/r3/r4 指向同一个地址，
    且可变指针和不可变指针同时存在。
    */</span>
    <span class="token keyword">let</span> r3 <span class="token operator">=</span> <span class="token operator">&amp;</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r4 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>

    <span class="token comment">//打印出指针本身的值，它们的值都是一样的</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r1 = {:#?}&quot;</span><span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r2 = {:#?}&quot;</span><span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r3 = {:#?}&quot;</span><span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r4 = {:#?}&quot;</span><span class="token punctuation">,</span> r4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>执行结果如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>r1 <span class="token operator">=</span> 0x00007ffeec08643c
r2 <span class="token operator">=</span> 0x00007ffeec08643c
r3 <span class="token operator">=</span> 0x00007ffeec08643c
r4 <span class="token operator">=</span> 0x00007ffeec08643c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>剖析：</p> <ul><li>注意，不同时候不同设备打印出的地址值可能会不同</li> <li>上面这个例子中，裸指针指向一个已知的变量 <code>num</code></li> <li>变量 <code>num</code> 的可变性对 rust 来说是可检查的，因此，rust 对后续裸指针的可变性也进行了检查</li> <li>例如，如果创建 <code>*mut i32</code> 类型的裸指针，则 rust 会检查并确保变量 <code>num</code> 使用了 <code>mut</code> 修饰</li></ul> <blockquote><p>举例：创建一个可能无效的裸指针，也就是从任意地址值创建</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    通过任意地址值创建裸指针 r1
    由于该地址值无法确认有效性，
    因此rust不会检查对应的mut修饰
    */</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> 0x123456usize <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>
    <span class="token comment">/*
    类似的，
    通过 r1 创建 r2，
    通过 r2 创建 r3，
    由于地址值无法确认有效性，
    rust都不会检查可变性修饰，
    因此可以任意在 *const 和 *mut 之间转换
    */</span>
    <span class="token keyword">let</span> r2 <span class="token operator">=</span> r1 <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r3 <span class="token operator">=</span> r2 <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>

    <span class="token comment">//打印出指针本身的值，它们的值都是一样的</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r1 = {:#?}&quot;</span><span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r2 = {:#?}&quot;</span><span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;r3 = {:#?}&quot;</span><span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>执行结果如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>r1 <span class="token operator">=</span> 0x0000000000123456
r2 <span class="token operator">=</span> 0x0000000000123456
r3 <span class="token operator">=</span> 0x0000000000123456
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>剖析：</p> <ul><li>从任意地址创建裸指针时，rust 无法确认该地址的有效性，因此就会放弃对应的可变性检查</li> <li>所以，从上面例子可以看到，各个指针之间可以任意在 <code>*const</code> 和 <code>*mut</code> 之间转换，rust 不会做任何检查</li> <li>因此，从任意地址创建裸指针时，内存安全问题只能程序员自己保证</li></ul> <h3 id="裸指针的解引用"><a href="#裸指针的解引用" class="header-anchor">#</a> 裸指针的解引用</h3> <p>注意事项：</p> <ol><li>使用 <code>*</code> 来解引用裸指针，例如 <code>*r</code></li> <li>解引用裸指针的目的是：<em><strong>读取</strong></em> 或 <em><strong>修改</strong></em> 对应内存地址的值</li> <li>解引用裸指针的行为可能是不安全的（虽然有时候是安全的，例如指向一个确定的变量时），因此需要 <code>unsafe</code> 代码块</li></ol> <blockquote><p>举例：能够正常运行的代码</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> <span class="token number">89</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment">//打印结果为89</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*r2 = {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//修改num的值为99</span>
        <span class="token operator">*</span>r1 <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
        <span class="token comment">//打印结果为99</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*r2 = {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>运行结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>*r2 <span class="token operator">=</span> <span class="token number">89</span>
*r2 <span class="token operator">=</span> <span class="token number">99</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>剖析：</p> <ul><li>使用 <code>unsafe</code> 将解引用裸指针的代码包装起来，形成不安全代码块</li> <li>通过 <code>r2</code> 来读取所指向的内容（当然也可以通过 <code>r1</code> 来读取）</li> <li>通过 <code>r1</code> 来修改所指向的内容（因为 <code>r1</code> 是 <code>*mut</code> 类型）</li> <li>该程序能够正确执行，没有引起内存问题，但只要是解引用裸指针的行为，都仍须使用 <code>unsafe</code> 来包装</li></ul> <blockquote><p>举例：不能正确执行的代码</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> 0x123456usize <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r2 <span class="token operator">=</span> r1 <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*r1 = {:#?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>r2 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*r2 = {:#?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>剖析：</p> <ul><li>几乎在任何时候，<code>0x123456</code> 这个地址值都是无效的，不允许读，也不允许写</li> <li>因此该程序运行时会崩溃，从而针对该内存错误，我们可以到 <code>unsafe</code> 代码块中去排查，这也是 <code>unsafe</code> 修饰的作用</li></ul> <h2 id="调用不安全的函数或方法"><a href="#调用不安全的函数或方法" class="header-anchor">#</a> 调用不安全的函数或方法</h2> <p><em>函数与方法是类似的，本节用函数来讲解和说明。</em></p> <h3 id="定义和调用不安全函数"><a href="#定义和调用不安全函数" class="header-anchor">#</a> 定义和调用不安全函数</h3> <p>规则说明：</p> <ul><li>定义不安全函数时，也使用  <code>unsafe</code> 关键字，例如 <code>unsafe fn dangerous() {}</code> ，又如 <code>pub unsafe fn dangerous()</code></li> <li>一旦将函数定义为 <code>unsafe</code> ，那么整个函数体都是 <code>unsafe</code> ，因此，对于函数体中的不安全代码，不需要再使用 <code>unsafe</code> 代码块</li> <li>但是，对于调用者来说，调用不安全函数时，需要确保在 <code>unsafe</code> 修饰之下：例如，将调用者本身也定义为不安全函数；或者，在调用时使用 <code>unsafe</code> 代码块</li></ul> <blockquote><p>举例：定义不安全函数</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">dangerous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> 0x123456usize <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>
    <span class="token comment">/*
    该函数已经定义为 unsafe
    所以此处进行不安全操作时不需要 unsafe 代码块
    */</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;*r1 = {:#?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>举例：在安全函数中调用不安全函数</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    main 函数是安全的，
    但在调用不安全函数时，
    单独使用 unsafe 代码块
    */</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">dangerous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>举例：在不安全函数中调用不安全函数</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    调用者本身已经定义为不安全函数，
    因此可直接调用 dangerous() 这个不安全函数，
    不需要额外的 unsafe 代码块
    */</span>
    <span class="token function">dangerous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="安全函数中的不安全代码"><a href="#安全函数中的不安全代码" class="header-anchor">#</a> 安全函数中的不安全代码</h3> <h4 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h4> <ul><li>本节要讲的论点是：仅因为函数中包含一些不安全代码，就将整个函数都标记为  <code>unsafe</code> ，这种行为是不必要的</li> <li>在 rust 中，更常见的行为是：将函数标记为安全的，但是，安全函数中可以使用不安全代码，只是将这些不安全代码放在 <code>unsafe</code> 块中</li> <li>在前面的内容里，其实已经有多个这样的例子，比如 <code>main</code> 函数中，调用 <code>dangerous</code> 这个不安全函数时使用了 <code>unsafe</code> 代码块，但整个 <code>main</code> 函数是安全的</li> <li>要讲解这一点，举个简单的例子就能说明，但看到原书中使用了一个较为复杂的例子，因此借题发挥，索性多讲一点，从场景到问题，再到如何解决，从而理解更透彻一些</li></ul> <h4 id="场景"><a href="#场景" class="header-anchor">#</a> 场景</h4> <ul><li>考虑对 slice 的分割：获取一个 slice ，根据给定的索引参数，将其分割为另两个 slice</li> <li>rust 标准库中已经提供了实现，但此处我们自己来实现，且简单起见，将该功能实现为函数，而且只处理 <code>i32</code> 类型的 slice ，而不是像标准库一样可以处理泛型的 <code>T</code></li> <li>该需求很容易实现，代码如下：</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">split_at</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获得slice长度</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//索引不能超过slice的长度</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>idx <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//利用slice的切片功能，分割为另两个slice</span>
    <span class="token punctuation">(</span><span class="token operator">&amp;</span>slice<span class="token punctuation">[</span><span class="token punctuation">..</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>slice<span class="token punctuation">[</span>idx<span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> <span class="token function">split_at</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>打印结果是：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">4</span>, <span class="token number">5</span>, <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h4> <ul><li>上面的场景里，我们处理的是不可变的 slice ，因此很容易就实现了</li> <li>但更换一下需求，我们处理 mut 的 slice ，且分割后的另两个 slice 也是 mut</li> <li>对应的，我们更改代码如下（无法编译）：</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">split_at_mut</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assert!</span><span class="token punctuation">(</span>idx <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> slice<span class="token punctuation">[</span><span class="token punctuation">..</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> slice<span class="token punctuation">[</span>idx<span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>此时编译错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>error<span class="token punctuation">[</span>E0499<span class="token punctuation">]</span>: cannot borrow <span class="token variable"><span class="token variable">`</span>*slice<span class="token variable">`</span></span> as mutable <span class="token function">more</span> than once at a <span class="token function">time</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>原因是：</p> <ul><li>在返回的元组中，我们同时产生了两个对 slice 的 mut 借用（引用）</li> <li>而在 rust 的借用规则中，不允许同时存在多个 mut 的引用</li> <li>虽然程序员知道这两个引用对应的 slice 并没有重叠，也不会引起数据访问冲突，但这不是 rust 所关注的点，对 rust 来说，这样的行为是违反其借用规则的</li></ul> <h4 id="解决"><a href="#解决" class="header-anchor">#</a> 解决</h4> <ul><li>要解决该问题，就需要使用裸指针</li> <li>裸指针可以突破 rust 的借用规则，从而让多个 mut 引用可以同时存在</li> <li>当然，对应的安全保证就需要交给程序员自己（在该例子中，我们确实能保证安全）</li> <li>解决该问题时，代码中使用了许多 slice 对应裸指针的 API ，这些 API 可以参考 rust 文档，本节只对这些 API 进行了简单的注释，但也能理解了</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>slice<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">split_at_mut</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获得slice长度</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    获得slice对应的裸指针
    也就是slice对应的内存起始地址
    注意：
    只要没有解引用裸指针，就不需要使用unsafe
    */</span>
    <span class="token keyword">let</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//确保分割索引小于slice长度</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>idx <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
    [需使用unsafe]
    从给定的指针地址开始，
    获取连续的idx个元素，
    从而形成slice片段
    */</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        第一个slice片段：
        起始地址是ptr
        获取个数是idx
        */</span>
        <span class="token punctuation">(</span>slice<span class="token punctuation">::</span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*
        第二个slice片段：
        起始地址是ptr+idx，
        但真实的内存地址与元素类型有关，
        所以安全的操作方式是ptr.offset，
        这一点C++程序员可能比较容易理解；
        获取个数是len-idx
        */</span>
         slice<span class="token punctuation">::</span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>idx <span class="token keyword">as</span> isize<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token operator">-</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h4 id="引申"><a href="#引申" class="header-anchor">#</a> 引申</h4> <ul><li>再回到最初的场景，分割非 mut 的 slice ，是否也可以用裸指针不安全代码</li> <li>答案是可以的，如果喜欢这么做的话（比如想找点 C++ 的感觉）</li> <li>参看下面的代码，使用类似的 rust 提供的不安全代码来完成非 mut 的 slice 分割</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>slice<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">split_at_mut</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获得slice长度</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获得slice对应的非mut裸指针</span>
    <span class="token keyword">let</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//确保分割索引小于slice长度</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>idx <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//从裸指针获得对应的非mut片段</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>slice<span class="token punctuation">::</span><span class="token function">from_raw_parts</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">,</span>
         slice<span class="token punctuation">::</span><span class="token function">from_raw_parts</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>idx <span class="token keyword">as</span> isize<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token operator">-</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>再引申：</p> <ul><li>甚至，连 <code>ptr.offset</code> 都不使用，自己来计算内存地址偏移</li> <li>也就是 <code>size_of(type) * num</code> ，详情参考注释</li> <li>当然，这样的话代码会变得更复杂，纯粹为了学习目的（或者说找到 C++ 的感觉）</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>slice<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">split_at_mut</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获得slice长度</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获得slice对应的非mut裸指针</span>
    <span class="token keyword">let</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//确保分割索引小于slice长度</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>idx <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
    起始地址是 ptr ，
    偏移 idx 个元素，元素类型是 i32 ，
    因此自行计算实际的内存便宜地址，
    计算过程中需要进行类型转换，
    此时得到的内存地址是 usize 类型
    */</span>
    <span class="token keyword">let</span> ptr2 <span class="token operator">=</span> ptr <span class="token keyword">as</span> usize <span class="token operator">+</span> idx <span class="token operator">*</span> mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//从裸指针获得对应的非mut片段</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>slice<span class="token punctuation">::</span><span class="token function">from_raw_parts</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token comment">//此处需要将 usize 值转换为裸指针类型</span>
         slice<span class="token punctuation">::</span><span class="token function">from_raw_parts</span><span class="token punctuation">(</span>ptr2 <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">,</span> len<span class="token operator">-</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h4> <ul><li>直接从裸指针（内存地址）开始进行一个内存片段的截取是不安全的，这也是必须使用 <code>unsafe</code> 的原因</li> <li>上面的例子中，我们都确保了内存安全</li> <li>我们可以故意制造一个会引起内存问题的事故：比如让使用一个无效的内存起始地址，或者截取不恰当的内存长度</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> std<span class="token punctuation">::</span>slice<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>i32<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        无效的内存其实地址，
        对应的长度片段也不可访问，
        因此程序会崩溃
        */</span>
        slice<span class="token punctuation">::</span><span class="token function">from_raw_parts</span><span class="token punctuation">(</span>0x123456usize <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="与其它语言交互"><a href="#与其它语言交互" class="header-anchor">#</a> 与其它语言交互</h3> <h4 id="rust-调用其它语言"><a href="#rust-调用其它语言" class="header-anchor">#</a> rust 调用其它语言</h4> <ul><li>首先需要创建 <em><strong>FFI</strong></em>（<em><strong>foreign function interface</strong></em>），使用 <code>extern</code> 关键字，在 FFI 中创建函数的签名（注意函数名称必须与外部函数名一致），且这个签名使用的 rust 语法</li> <li>同时需要指定 <em><strong>ABI</strong></em>（<em><strong>application binary interface</strong></em>），ABI 定义了如何在汇编层面调用此函数，例如 C 语言最常见的 ABI 是 <code>&quot;C&quot;</code></li> <li>举例：创建 C 函数的 FFI 时，就是 <code>extern &quot;C&quot; { fn ... }</code></li> <li>最后，在调用 FFI 时，必须使用 <code>unsafe</code></li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/*
使用 rust 语法来创建 FFI，
其中 ABI 是 &quot;C&quot;，
要调用的 C 库函数是 abs，该名称必须保持一致
*/</span>
<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">abs</span><span class="token punctuation">(</span>i<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> i32<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//必须使用 unsafe</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment">//打印结果是 3</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;abs(-3) = {}&quot;</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="其它语言调用-rust"><a href="#其它语言调用-rust" class="header-anchor">#</a> 其它语言调用 rust</h4> <ul><li>首先，对函数增加 <code>extern</code> 关键字修饰，并指定 ABI ，例如 <code>extern &quot;C&quot;</code></li> <li>其次，为函数增加 <code>#[no_mangle]</code> 标注，从而禁用 rust 编译器对该函数名的 mangle 行为（不同的语言及编译器有着不同的 mangle 规则）</li> <li>这样，其它语言就能调用该函数</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function">for_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;can be called from C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="使用-mut-静态变量"><a href="#使用-mut-静态变量" class="header-anchor">#</a> 使用 <code>mut</code> 静态变量</h2> <h3 id="认识静态变量"><a href="#认识静态变量" class="header-anchor">#</a> 认识静态变量</h3> <ul><li>rust 是有全局变量的，只是到目前为止都未讲解</li> <li>而 rust 的全局变量就是静态（<em><strong>static</strong></em>）变量，使用 <code>static</code> 关键字修饰</li> <li>其它语法与常量一样（参考 Chapter3 ：全部大写、使用 <code>_</code> 分隔、必须标注类型）</li> <li>如果静态变量的类型是引用，则默认且只能是 <code>'static</code> 生命周期（参考 Chapter10）</li> <li>访问不可变的静态变量是安全的（这个很好理解），但访问（包括读/写）可变的静态变量则都是不安全的，后续会讲解</li></ul> <blockquote><p>常量和静态变量看起来类似，但它们的区别是：</p> <ol><li>静态变量有固定的内存地址，访问静态变量时总是访问这个内存地址；而常量则允许在被访问时进行数据复制，而不是访问同一个内存地址</li> <li>静态变量默认是不可变的，若需要可变，则使用 <code>mut</code> 修饰；而常量是不可变的，且总是使用 <code>const</code> 关键字来修饰</li></ol></blockquote> <p>下面是使用不可变静态变量的例子：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/*
使用 static 关键字修饰，
且该静态变量是不可变的，
该引用默认是 'static 生命周期
*/</span>
<span class="token keyword">static</span> HELLO_WORD<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str <span class="token operator">=</span> <span class="token string">&quot;hello, world!&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//访问不可变的静态变量不需要使用 unsafe</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;name is {}&quot;</span><span class="token punctuation">,</span> HELLO_WORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="mut-静态变量"><a href="#mut-静态变量" class="header-anchor">#</a> <code>mut</code> 静态变量</h3> <p>下面是访问（读/写）<code>mut</code> 静态变量的例子：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//使用 mut 修饰为可变的静态变量</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">//对静态变量进行写操作</span>
<span class="token keyword">fn</span> <span class="token function">add_counter</span><span class="token punctuation">(</span>inc<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//写操作需要 unsafe</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        COUNTER <span class="token operator">+=</span> inc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//读操作也需要 unsafe</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此时为 0</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;counter(before) = {}&quot;</span><span class="token punctuation">,</span> COUNTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//对静态变量的值进行修改</span>
    <span class="token function">add_counter</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment">//此时为 8</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;counter(after) = {}&quot;</span><span class="token punctuation">,</span> COUNTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>剖析：</p> <ul><li>上面的例子运行符合预期，因为只是单线程</li> <li>但多线程访问 <code>mut</code> 静态变量时，会带来数据竞争问题，这也是必须使用 <code>unsafe</code> 的原因</li> <li>rust 的建议是，优先使用 Chapter16 的安全并发技术</li></ul> <h2 id="不安全的-trait"><a href="#不安全的-trait" class="header-anchor">#</a> 不安全的 trait</h2> <ul><li><span style="background-color:#dddd00;">只要 trait 中有任何方法存在编译器不能验证的 invariant ，那么这个 trait 就是 unsafe </span></li> <li>语法是：定义和实现 trait 时，都使用 <code>unsafe</code> 关键字修饰</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">unsafe</span> <span class="token keyword">trait</span> Foo <span class="token punctuation">{</span>
    <span class="token comment">// methods go here</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Foo <span class="token keyword">for</span> i32 <span class="token punctuation">{</span>
    <span class="token comment">// method implementations go here</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2/27/2020, 8:35:50 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Rust/Rust_Book_Exp/18 Patterns and Matching/03 Pattern Syntax.html" class="prev">
        18.3. 模式的全部语法
      </a></span> <span class="next"><a href="/Rust/Rust_Book_Exp/19 Advanced Features/02 Advanced Traits.html">
        19.2. 高级 trait
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b639eb72.js" defer></script><script src="/assets/js/2.5df156af.js" defer></script><script src="/assets/js/90.e0f850a2.js" defer></script>
  </body>
</html>
