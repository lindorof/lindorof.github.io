<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>13.2. 迭代器 Iterator | Lindorof</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Lindorof's Blog">
    <link rel="preload" href="/assets/css/0.styles.8ac2847d.css" as="style"><link rel="preload" href="/assets/js/app.b639eb72.js" as="script"><link rel="preload" href="/assets/js/2.5df156af.js" as="script"><link rel="preload" href="/assets/js/69.6f9ff293.js" as="script"><link rel="prefetch" href="/assets/js/10.ee4568ff.js"><link rel="prefetch" href="/assets/js/11.8db0767a.js"><link rel="prefetch" href="/assets/js/12.92a4e660.js"><link rel="prefetch" href="/assets/js/13.e2450b62.js"><link rel="prefetch" href="/assets/js/14.5ae14743.js"><link rel="prefetch" href="/assets/js/15.62a967cf.js"><link rel="prefetch" href="/assets/js/16.3482df63.js"><link rel="prefetch" href="/assets/js/17.881a9d91.js"><link rel="prefetch" href="/assets/js/18.d6e19ee5.js"><link rel="prefetch" href="/assets/js/19.caf0829a.js"><link rel="prefetch" href="/assets/js/20.a80e123c.js"><link rel="prefetch" href="/assets/js/21.9c810086.js"><link rel="prefetch" href="/assets/js/22.bc5f69cb.js"><link rel="prefetch" href="/assets/js/23.f15ef55d.js"><link rel="prefetch" href="/assets/js/24.b8714e3e.js"><link rel="prefetch" href="/assets/js/25.d673c092.js"><link rel="prefetch" href="/assets/js/26.28d57b84.js"><link rel="prefetch" href="/assets/js/27.d8b15b76.js"><link rel="prefetch" href="/assets/js/28.2574be13.js"><link rel="prefetch" href="/assets/js/29.54667d47.js"><link rel="prefetch" href="/assets/js/3.f6602695.js"><link rel="prefetch" href="/assets/js/30.dd697263.js"><link rel="prefetch" href="/assets/js/31.aafbc8db.js"><link rel="prefetch" href="/assets/js/32.5fe2531d.js"><link rel="prefetch" href="/assets/js/33.c3dfca3c.js"><link rel="prefetch" href="/assets/js/34.22613e38.js"><link rel="prefetch" href="/assets/js/35.aad9af2b.js"><link rel="prefetch" href="/assets/js/36.badbd522.js"><link rel="prefetch" href="/assets/js/37.45905373.js"><link rel="prefetch" href="/assets/js/38.ab0de43e.js"><link rel="prefetch" href="/assets/js/39.d1a7492c.js"><link rel="prefetch" href="/assets/js/4.c7710dca.js"><link rel="prefetch" href="/assets/js/40.92c4cb14.js"><link rel="prefetch" href="/assets/js/41.cc19be50.js"><link rel="prefetch" href="/assets/js/42.c9b4b585.js"><link rel="prefetch" href="/assets/js/43.1af966c8.js"><link rel="prefetch" href="/assets/js/44.40ebac1c.js"><link rel="prefetch" href="/assets/js/45.469b8553.js"><link rel="prefetch" href="/assets/js/46.eb491d21.js"><link rel="prefetch" href="/assets/js/47.03d1fbf2.js"><link rel="prefetch" href="/assets/js/48.af296c16.js"><link rel="prefetch" href="/assets/js/49.3a42b55b.js"><link rel="prefetch" href="/assets/js/5.339eb2f5.js"><link rel="prefetch" href="/assets/js/50.ef35a161.js"><link rel="prefetch" href="/assets/js/51.284d50de.js"><link rel="prefetch" href="/assets/js/52.c4983004.js"><link rel="prefetch" href="/assets/js/53.83c193e1.js"><link rel="prefetch" href="/assets/js/54.08f26cd6.js"><link rel="prefetch" href="/assets/js/55.ef20313b.js"><link rel="prefetch" href="/assets/js/56.dc2772cf.js"><link rel="prefetch" href="/assets/js/57.add26447.js"><link rel="prefetch" href="/assets/js/58.ff8f2704.js"><link rel="prefetch" href="/assets/js/59.43fdbc04.js"><link rel="prefetch" href="/assets/js/6.0ce72a94.js"><link rel="prefetch" href="/assets/js/60.1a27c7c3.js"><link rel="prefetch" href="/assets/js/61.9ca63ff6.js"><link rel="prefetch" href="/assets/js/62.9ab09b12.js"><link rel="prefetch" href="/assets/js/63.a6b6d595.js"><link rel="prefetch" href="/assets/js/64.5e9ac56b.js"><link rel="prefetch" href="/assets/js/65.bcfb6015.js"><link rel="prefetch" href="/assets/js/66.5024eb22.js"><link rel="prefetch" href="/assets/js/67.5d83f99f.js"><link rel="prefetch" href="/assets/js/68.80f05874.js"><link rel="prefetch" href="/assets/js/7.726c7fbf.js"><link rel="prefetch" href="/assets/js/70.92b749fb.js"><link rel="prefetch" href="/assets/js/71.a4248217.js"><link rel="prefetch" href="/assets/js/72.29aeb940.js"><link rel="prefetch" href="/assets/js/73.8918e90b.js"><link rel="prefetch" href="/assets/js/74.81fd32da.js"><link rel="prefetch" href="/assets/js/75.5357ccc2.js"><link rel="prefetch" href="/assets/js/76.66fc1725.js"><link rel="prefetch" href="/assets/js/77.6f29512b.js"><link rel="prefetch" href="/assets/js/78.a63871cd.js"><link rel="prefetch" href="/assets/js/79.c646997c.js"><link rel="prefetch" href="/assets/js/8.81d630fc.js"><link rel="prefetch" href="/assets/js/80.b5d5ad39.js"><link rel="prefetch" href="/assets/js/81.601aa569.js"><link rel="prefetch" href="/assets/js/82.99bc0640.js"><link rel="prefetch" href="/assets/js/83.06d4defc.js"><link rel="prefetch" href="/assets/js/84.44856307.js"><link rel="prefetch" href="/assets/js/85.3b88ee80.js"><link rel="prefetch" href="/assets/js/86.47c806cb.js"><link rel="prefetch" href="/assets/js/87.b5201cdf.js"><link rel="prefetch" href="/assets/js/88.f9ce8655.js"><link rel="prefetch" href="/assets/js/89.c1f12bf1.js"><link rel="prefetch" href="/assets/js/9.b6118830.js"><link rel="prefetch" href="/assets/js/90.e0f850a2.js"><link rel="prefetch" href="/assets/js/91.8166ca11.js"><link rel="prefetch" href="/assets/js/92.6ba6ce27.js"><link rel="prefetch" href="/assets/js/93.6e09fb58.js"><link rel="prefetch" href="/assets/js/94.1b324565.js"><link rel="prefetch" href="/assets/js/95.5308659f.js"><link rel="prefetch" href="/assets/js/96.306bee11.js"><link rel="prefetch" href="/assets/js/97.6e231fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ac2847d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Lindorof" class="logo"> <span class="site-name can-hide">Lindorof</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Rust/Rust_Book_Exp/" aria-current="page" class="sidebar-link">「RustBook」学习心得</a></li><li><a href="/Rust/Rust_Book_Exp/01 Getting Started/01 Getting Started.html" class="sidebar-link">1. 开始</a></li><li><a href="/Rust/Rust_Book_Exp/02 Programming a Guessing Game/01 Programming a Guessing Game.html" class="sidebar-link">2. 猜谜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3. 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>4. 所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>5. 结构体</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>6. 枚举</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>7. 模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>8. 集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>9. 错误处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>10. 泛型及生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>11. 自动测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>12. 命令行</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>13. 闭包及迭代器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Rust/Rust_Book_Exp/13 Functional Programming about Closure and Iterator/01 Closures that Anonymous Functions can Capture their Environment.html" class="sidebar-link">13.1. 匿名函数 Closure</a></li><li><a href="/Rust/Rust_Book_Exp/13 Functional Programming about Closure and Iterator/02 Processing a Series of Items with Iterators.html" class="active sidebar-link">13.2. 迭代器 Iterator</a></li><li><a href="/Rust/Rust_Book_Exp/13 Functional Programming about Closure and Iterator/03 Improving Our IO Project.html" class="sidebar-link">13.3. 改进 minigrep</a></li><li><a href="/Rust/Rust_Book_Exp/13 Functional Programming about Closure and Iterator/04 Comparing Performance about Loop and Iterator.html" class="sidebar-link">13.4. 性能比较 Loop &amp; Iterator</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>14. Cargo 和 Crates.io</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>15. 智能指针</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>16. 无畏并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>17. 面向对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>18. 模式与匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>19. 高级特征</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_13-2-迭代器-iterator"><a href="#_13-2-迭代器-iterator" class="header-anchor">#</a> 13.2. 迭代器 Iterator</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>关于 iterator ：</p> <ul><li>iterator 可以处理序列化的 item</li> <li>iterator 负责 item 遍历的逻辑，并确定是否已遍历完毕</li> <li>对于使用者来说，只用关心对所遍历的 item 进行的操作，而不用关注如何去遍历</li></ul> <p>iterator 的本质：</p> <ul><li>iterator 是一种 Trait ，该 Trait 叫 <code>Iterator</code></li> <li>也就是说，要使用 iterator 的方法，需要基于一个实现了 <code>Iterator</code> 这种 Trait 的对象</li> <li>那么，这个实现了 <code>Iterator</code> Trait 的对象内包含了一些数据和逻辑，例如遍历的起始位置，以及判断如何定位到下一个 item ，还有，判断是否已经遍历完毕</li> <li>以常见的 Vector 为例，例如 <code>let v = vec![1, 2, 3]</code> ，则 <code>v</code> 本身是一个对象</li> <li>然后我们通过 <code>let it = v.iter()</code> 得到了 iterator ，也就是 <code>it</code> ，它本身也是一个对象，但这个对象实现了 <code>Iterator</code> 这个 Trait</li> <li>因此要注意的是，上面的 <code>v</code> 和 <code>it</code> 是两个对象，这两个对象内部存储的数据是不同的：<code>v</code> 存储的是各个元素的内容，而 <code>it</code> 存储的可能是 <code>v</code> 中元素的起始位置、遍历的逻辑等；也就是说，数据的存储与数据的遍历，可能是两个对象</li> <li>而另一种情况，既然 <code>Iterator</code> 是一种 Trait ，那么我们可以直接为存储数据的对象实现这种 Trait ，那么此时，数据的存储与数据的遍历就是同一个对象</li></ul> <p>iterator 的特性：</p> <ul><li>iterator 是 lazy 的（惰性）</li> <li>也就是说，在创建了一个 iterator 的时候，数据并没有被遍历，因为此时仅仅是创建了一个 iterator 而已</li> <li>因此，iterator 的方法有两种，一种是 <em><strong>Consume</strong></em> ，一种是 <em><strong>Produce</strong></em></li> <li><em><strong>Consume</strong></em> 就是消费，可以理解为，这种方法会进行数据的遍历，直到 iterator 告知遍历已结束</li> <li><em><strong>Produce</strong></em> 就是生产，这种方法不会进行数据的遍历，而是改变或拓展了 iterator 的行为，例如，对于每个 item ，允许我们查看、修改、过滤它们，甚至由此产生新的序列化的 item</li> <li>所以，我们可以将多个 <em><strong>Produce</strong></em> 方法连在一起调用，类似于 <code>iterator.p1().p2().px()</code> ，可以把这种调用理解为一连串精密的环环相扣的齿轮，最终需要 <em><strong>Consume</strong></em> 的调用才能让这一连串齿轮运转起来</li></ul> <h2 id="iterator-trait"><a href="#iterator-trait" class="header-anchor">#</a> <code>Iterator</code> Trait</h2> <p>说明：</p> <ul><li><code>Iterator</code> 是 Rust 标准库中定义的 Trait</li> <li>这个 Trait 中有很多方法，但是 Rust 都进行了默认实现</li> <li>除了一个方法：<code>next</code> ，因为这个方法决定了 item 如何遍历、遍历是否结束等逻辑</li></ul> <p>该 Trait 在 Rust 标准库中定义如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> Iterator <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Option<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// --Snip--</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>剖析：</p> <ul><li><code>type item</code> 详细在 Chapter 19 讲解，现在可以这样理解：<code>type</code> 表示后续会声明一种数据类型，这种数据类型就是 <code>Item</code> ，例如 <code>i32</code></li> <li>因此，<code>Option&lt;Self::Item&gt;</code> 表明了 <code>next</code> 方法得到的 item 的数据类型</li> <li>所以，如果遍历得到了下一个 item ，例如 <code>i32</code> 类型，则得到的结果是 <code>Some(&amp;i32)</code> ，而如果遍历已经结束，则得到的结果是 <code>None</code></li> <li>上述 <code>next</code> 方法就是 <code>Iterator</code> Trait 唯一没有被 Rust 标准库默认实现的方法</li> <li>注意，<code>next</code> 方法要求 <code>&amp;mut</code> ，因为这会改变 iterator 内部的数据，例如让 iterator 可以指向下一个 item</li></ul> <p>可以调用 <code>Iterator</code> 的 <code>next</code> 方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> <span class="token keyword">mut</span> it <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert_eq!</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert_eq!</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert_eq!</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert_eq!</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>代码剖析：</p> <ol><li>通过 <code>iter()</code> 得到 iterator</li> <li>通过 <code>next()</code> 得到第一个遍历的 item</li> <li>由于 <code>next()</code> 会改变 iterator ，因此需要对 <code>it</code> 使用 <code>mut</code> 修饰</li> <li>对于 <code>vec![1, 2, 3]</code> 来说，多次调用 <code>next()</code> 时，依次得到的 item 是 <code>Some(&amp;1), Some(&amp;2), Some(&amp;3)</code> ，此时 item 已遍历完毕，因此下一次得到的是 <code>None</code></li> <li>注意，如果继续调用 <code>next()</code> ，不管多少次，都是继续得到 <code>None</code></li> <li>另外，得到的 item 是 <code>&amp;i32</code> ，也可以得到 <code>&amp;mut i32</code> ，或者 <code>move i32</code> ，后续再讲</li></ol> <h2 id="consume-方法"><a href="#consume-方法" class="header-anchor">#</a> <em><strong>Consume</strong></em> 方法</h2> <p>说明：</p> <ul><li><em><strong>Consume</strong></em> 方法对 iterator 进行消费，也就是说，会不断的调用 <code>next()</code> ，直到得到结果 <code>None</code> ，即遍历结束</li> <li><code>Iterator</code> 中很多 <em><strong>Consume</strong></em> 方法，例如 <code>sum()</code> 用来遍历并计算所有 item 的相加的总和；又如，<code>for</code> 只是遍历 item</li></ul> <h3 id="for"><a href="#for" class="header-anchor">#</a> <code>for</code></h3> <p>例如下面的代码，进行最简单的遍历：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="sum"><a href="#sum" class="header-anchor">#</a> <code>sum</code></h3> <p>例如下面的代码，遍历每个 item 并相加得到总和：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> total<span class="token punctuation">:</span> i32 <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 相加总和是6</span>
<span class="token function">assert_eq!</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="collect"><a href="#collect" class="header-anchor">#</a> <code>collect</code></h3> <p>说明：</p> <ul><li>这也是一个消费方法，用来将遍历的 item 收集成为另一份序列化的数据</li> <li>例如下面的例子，没有任何意义，因为它将一个 Vector 收集为原样的另一个 Vector</li> <li>但是后面的讲解会使用到 <code>collect</code> ，我们需要理解它是一个消费方法</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> v1<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印 [1, 2, 3]</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="produce-方法"><a href="#produce-方法" class="header-anchor">#</a> <em><strong>Produce</strong></em> 方法</h2> <p>说明：</p> <ul><li><em><strong>Produce</strong></em> 方法也叫 <em><strong>iterator adaptor</strong></em> ，即迭代器的适配</li> <li>因此，<em><strong>Produce</strong></em> 方法不会对 iterator 进行遍历，也就是说，不会调用 <code>next()</code> ，而是通过对 iterator 的适配，拓展了 iterator 的功能，例如可以让我们查看、修改、过滤所遍历到的 item</li></ul> <h3 id="map"><a href="#map" class="header-anchor">#</a> <code>map</code></h3> <p>作用：</p> <ul><li>允许对 item 进行处理</li> <li>这个处理通过 Closure 来完成</li> <li>Closure 返回一个新的 item</li></ul> <p>例如下面的例子：</p> <ul><li>会得到一个 warning ，因为没有消费 iterator</li> <li>warning 的原文是 <code>iterators are lazy and do nothing unless consumed</code></li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因此需要消费 iterator ，例如调用 <code>collect</code> 来进行消费，得到另一份新的序列化数据：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印结果是 [2, 3, 4]</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="filter"><a href="#filter" class="header-anchor">#</a> <code>filter</code></h3> <p>作用：</p> <ul><li>允许对 item 进行过滤</li> <li>过滤操作通过 Closure 来完成</li> <li>Closure 返回 true ，则 item 被收集，否则被过滤</li></ul> <p>例如：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 注意需要 **i 来解引用，因为参数是 &amp;&amp;i32</span>
	<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印结果是 [1, 3, 5]</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="closure-闭包"><a href="#closure-闭包" class="header-anchor">#</a> Closure 闭包</h3> <p>由于 iterator 的方法可能提供 Closure ，而 Closure 具备闭包特性，因此访问上下文环境，例如下面的例子：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> para <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token comment">// 访问了上下文环境即para</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>i <span class="token operator">==</span> para<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印结果是 [10, 10, 10]</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="iteraotr-ownship"><a href="#iteraotr-ownship" class="header-anchor">#</a> <code>Iteraotr</code> &amp; Ownship</h2> <p>使用 iterator 的时候，需要关注所有权，包括：</p> <ul><li>iterator 本身的所有权</li> <li>iterator 遍历得到的 item 的所有权</li></ul> <h3 id="关于-iterator"><a href="#关于-iterator" class="header-anchor">#</a> 关于 <code>Iterator</code></h3> <p><code>Iterator</code> 在执行某些操作之后，所有权即被 move ，之后不能再被使用，包括但不限于：</p> <ul><li><p><code>for</code></p></li> <li><p><code>sum</code></p></li> <li><p><code>map</code></p></li> <li><p><code>filter</code></p></li> <li><p><code>collect</code></p></li></ul> <blockquote><p>例如 <code>for</code> 循环之后，<code>it</code> 不再可用</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> it <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// it此时被move</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> it <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 编译器报错，it已不可用</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>进一步剖析：</p> <ul><li>前面讲过，<code>Iterator</code> 最重要的方法是 <code>next()</code> ，它会改变 iterator 自身，因此对应的变量需要 <code>mut</code> 修饰</li> <li>但是从上面的例子来看，<code>it</code> 并没有 <code>mut</code> 修饰</li> <li>这是因为 <code>it</code> 已经被 move 到 <code>for</code> 循环中，然后在 <code>for</code> 内部使用了 <code>mut</code> 变量来接收 <code>it</code></li></ul> <blockquote><p>又如 <code>sum</code> 方法，<code>it</code> 也会 move</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> it <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// it 此时被move</span>
<span class="token keyword">let</span> sum<span class="token punctuation">:</span> i32 <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 编译器报错，it已不可用</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>下面的例子看到，<code>map</code> 、<code>collect</code> 也会导致 move</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 创建it1</span>
<span class="token keyword">let</span> it1 <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// it1被move</span>
<span class="token keyword">let</span> it2 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>z<span class="token operator">|</span> z<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ite2被move</span>
<span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 编译器报错，it1和it2已不可用</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> it1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> it2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>代码剖析：</p> <ol><li>从上面的例子看到，<code>map</code> 是一种 <em><strong>Produce</strong></em> 方法，它并不会消费 iterator ，只是产生了另一个 iterator</li> <li>同时，也可以看到，<code>collect</code> 是一种 <em><strong>Consume</strong></em> 方法，它消费 iterator</li> <li>另外，不管 <em><strong>Produce</strong></em> 方法还是 <em><strong>Consume</strong></em> 方法，它们所操作的 iterator 都被 move</li></ol> <h3 id="关于-item"><a href="#关于-item" class="header-anchor">#</a> 关于 item</h3> <p>item 会被遍历，因此遍历得到的 item 也存在所有权问题，一般有如下几种方式得到 item ，对应了 item 不同的所有权：</p> <ul><li><code>iter</code> ，得到的是 <code>&amp;Item</code></li> <li><code>into_iter</code> ，得到的是被 move 的 <code>Item</code></li> <li><code>iter_mut</code> ，得到的是 <code>&amp;mut Item</code></li></ul> <blockquote><p>下面通过例子来剖析这几种方法的区别及使用场景</p></blockquote> <p>由于 <code>iter</code> 得到的是 <code>&amp;Item</code> ，因此在某些场景下会非常不方便，看下面的例子：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">use_closure</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>i <span class="token operator">%</span> p <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>代码剖析：</p> <ul><li>上述代码编译报错，错误提示 <code>Vec&lt;i32&gt; cannot be built from Iterator&lt;Item=&amp;i32&gt;</code></li> <li>也就是说，<code>collect()</code> 收集得到的 item 是 <code>&amp;i32</code> ，而 <code>use_cosure</code> 方法的返回值类型是 <code>Vec&lt;i32&gt;</code></li> <li>而这是因为 <code>iter()</code> 得到是 <code>&amp;32</code> ，对应的 <code>filter</code> 过滤之后得到的 item 也是 <code>&amp;i32</code></li> <li>顺便再说一下 <code>filter</code> 方法：因为该方法的作用只是判断每个 item 是否需要被过滤，并不需要对 item 进行修改，也不需要获得 item 的所有权，因此对于 <code>v.iter()</code> 得到的 item ，是通过 <code>&amp;</code> 的方式传递给 Closure</li> <li>也就是说，<code>v.iter()</code> 得到 <code>&amp;i32</code> ，接着 <code>filter</code> 的参数是 <code>&amp;&amp;i32</code></li> <li>因此，在上面的例子里，<code>filter</code> 的 Closure 参数 <code>i</code> 需要进行两次解引用，即 <code>**i</code></li></ul> <p>要解决上述问题，最简单的办法是使用 <code>into_iter()</code> ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">use_closure</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	v<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span>i <span class="token operator">%</span> p <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>代码剖析：</p> <ul><li><code>into_iter()</code> 得到的是 move 后的 <code>i32</code></li> <li>接着， <code>filter</code> 以 <code>&amp;32</code> 形式传递给 Closure</li> <li>因此 Closure 中只需要进行一次解引用，即 <code>*i</code></li> <li>经过 <code>filter</code> 过滤之后，得到的 item 依然是 <code>i32</code> 类型，因此可以被 <code>Vec&lt;i32&gt;</code> 收集</li> <li>另外，其实 Closure 中也可以直接写为 <code>i % p != 0</code> ，也就是说，编译器对于 <code>%</code> 运算，会自动进行解引用，而代码中之所以仍然写为 <code>*i</code> ，目的只是为了说明 <code>filter</code> 方法给 Closure 传递的参数类型</li></ul> <p>如果我们坚持使用 <code>iter()</code> ，则可以尝试一下，代码会变得复杂而有趣：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> use_closure<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Vec<span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> i32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>i <span class="token operator">%</span> p <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>代码剖析：</p> <ul><li>首先，根据前面的讲解，<code>collect</code> 所收集的 item 是 <code>&amp;32</code> ，所以需要将 <code>use_closure</code> 方法的返回值类型更改为 <code>Vec&lt;&amp;i32&gt;</code></li> <li>但此时仍然编译报错，因为返回的是引用，需要进行 lifetime 标注，所以，返回值增加了 <code>'a</code> 来标注 lifetime</li> <li>此时再编译，仍然报错，错误提示是 <code>returns a value referencing data owned by the current function</code></li> <li>也就是说，参数 <code>v</code> 是被 move 到 <code>use_closure</code> 中的，在 <code>use_closure</code> 执行完毕后，<code>v</code> 就自动被销毁，而返回值却引用了 <code>v</code> 中的数据，这是不被允许的</li></ul> <p>所以，要解决该问题，只能将 <code>v</code> 作为引用传入，并为 <code>v</code> 标注 lifetime ，从而完美接解决问题：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> use_closure<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Vec<span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> i32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>i <span class="token operator">%</span> p <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另外，注意 <code>into_iter()</code> 是将 item 的所有权进行了 move ，因此原数据已不再可用：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// v1中的item都被move</span>
	<span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> <span class="token operator">*</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 错误，v1已不可用</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 正确，v2可用</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>再看一个例子，<code>into_iter()</code> 之后传递给 <code>for</code> 循环：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// v中的item都被move</span>
	<span class="token keyword">let</span> it <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// it被move到for</span>
	<span class="token keyword">for</span> i <span class="token keyword">in</span> it <span class="token punctuation">{</span>
		<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// 错误，v已不可用</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 错误，v1已不可用</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>代码剖析：</p> <ul><li>需要注意一点，代码中使用了 <code>Vec&lt;i32&gt;</code> 来做例子</li> <li>我们知道 <code>i32</code> 的 move 本质上是拷贝，因此从内存的角度来看，其实 <code>v</code> 中的 item 是应该可用的</li> <li>但对于 Rust 编译器来说，既然 <code>v</code> 中的 item 所有权已被 <code>into_iter()</code> 进行了 move，则 <code>v</code> 就不再可用</li> <li>也就是说，Rust 关注的是所有权是否被 move ，而不会区别对待 <code>i32</code> 这种简单类型的 move 本质</li></ul> <p>最后看看 <code>iter_mut</code> ，用下面的例子，结合 <code>map</code> 方法，实现对原数据的更改，同时产生新数据：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为要使用iter_mut</span>
    <span class="token comment">// 所以需对v1使用mut修饰</span>
	<span class="token keyword">let</span> <span class="token keyword">mut</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印结果是 [1, 2, 3]</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历到的item是 &amp;mut i32</span>
	<span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token comment">// 首先对原数据进行加1操作</span>
    	<span class="token comment">// 然后再次加1得到新数据</span>
		<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>i<span class="token punctuation">|</span></span> <span class="token punctuation">{</span> <span class="token operator">*</span>i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">*</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印结果是 [2, 3, 4]</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印结果是 [3, 4, 5]</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="关于解引用"><a href="#关于解引用" class="header-anchor">#</a> 关于解引用</h3> <p>从上面的例子里，可以看到引用和解引用挺繁琐的，而且有时候可以由编译器自动解引用，有时候需要手动显式的解引用，下面还是需要简单总结一下：</p> <ol><li>以 <code>Vec&lt;i32&gt;</code> 为例，看看 <code>filter</code> 和 <code>map</code> 对应的参数</li> <li><code>iter()</code> 得到 <code>&amp;i32</code> ，<code>iter().filter()</code> 传入 <code>&amp;&amp;i32</code> ，<code>iter().map()</code> 传入 <code>&amp;32</code></li> <li><code>iter_mut()</code> 得到 <code>&amp;mut i32</code> ，<code>iter().filter()</code> 传入 <code>&amp; &amp;mut i32</code> ，<code>iter().map()</code> 传入 <code>&amp;mut 32</code></li> <li><code>into_iter()</code> 得到 <code>i32</code> ，<code>iter().filter()</code> 传入 <code>&amp;i32</code> ，<code>iter().map()</code> 传入 <code>i32</code></li></ol> <p>解引用规则：</p> <ul><li>如果进行 <code>+,-,%</code> 等操作，则 <code>&amp;i32</code> 会被自动解引用</li> <li>如果进行 <code>==,&gt;,&lt;</code> 等比较操作，则 <code>&amp;i32</code> 需要显式的解引用</li> <li>上述操作对于 <code>&amp;&amp;i32 , &amp;mut 32 , &amp; &amp;mut i32</code> 都不会自动解引用，需要手动显式进行</li></ul> <h2 id="实现-iterator"><a href="#实现-iterator" class="header-anchor">#</a> 实现 <code>Iterator</code></h2> <p>前面的内容里，讲的都是 Rust 标准库中 iterator 的使用，包括：</p> <ul><li><p>使用标准库中的 Collection ，例如 <code>Vec</code></p></li> <li><p>调用标准库中 Collection 提供的 <code>iter, iter_mut, into_iter</code> 方法来得到 <code>Iterator</code></p></li> <li><p>使用 <code>Iterator</code> 中的方法</p></li> <li><p>而我们也可以为自己的数据类型实现 <code>Iterator</code></p></li></ul> <h3 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h3> <p>首先创建自己的数据类型：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">struct</span> Counter <span class="token punctuation">{</span>
	count<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Counter <span class="token punctuation">{</span>
	<span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Counter <span class="token punctuation">{</span>
		Counter <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>代码说明：</p> <ul><li>结构体 <code>Counter</code> 有 <code>new</code> 方法，用来创建新的实例</li> <li>新实例的 <code>count</code> 计数从 0 开始</li></ul> <h3 id="实现-next"><a href="#实现-next" class="header-anchor">#</a> 实现 <code>next</code></h3> <p>要实现 <code>Iterator</code> ，唯一实现的方法是 <code>next</code> ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> Iterator <span class="token keyword">for</span> Counter <span class="token punctuation">{</span>
    <span class="token comment">// 为Item赋值，即数据类型</span>
	<span class="token keyword">type</span> Item <span class="token operator">=</span> i32<span class="token punctuation">;</span>

    <span class="token comment">// 参数需使用 &amp;mut 修饰</span>
    <span class="token comment">// 返回值固定为 Option&lt;Self::Item&gt;</span>
	<span class="token keyword">fn</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Option<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过None表示遍历完毕</span>
		<span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token punctuation">{</span>
			<span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			None
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>代码说明：</p> <ul><li>首先需要为 <code>Item</code> 赋值，其中，变量名称是 <code>Item</code> ，变量类型是 <code>type</code> ，变量值是 <code>i32</code></li> <li>然后实现 <code>next</code> ，参数需使用 <code>&amp;mut</code> 修饰，因为该方法需要改变数据内容</li> <li>返回值固定为 <code>Option&lt;Self::Item&gt;</code> ，其实本质就是 <code>Option&lt;i32&gt;</code> ，但写为 <code>Self::Item</code> 的好处是，我们只用关注 <code>type Item</code> 的值即可，不用对代码进行多处修改</li> <li>也就是说，如果我们直接将返回值写为 <code>Option&lt;i32&gt;</code> ，程序也是正确的</li> <li>根据上面的代码，可以看到该 iterator 一共可以循环 5 次，循环到的值分别是 <code>1, 2, 3, 4, 5</code></li></ul> <h3 id="使用-iterator"><a href="#使用-iterator" class="header-anchor">#</a> 使用 <code>Iterator</code></h3> <h4 id="使用-next"><a href="#使用-next" class="header-anchor">#</a> 使用 <code>next</code></h4> <p>现在 <code>Iterator</code> 已实现完毕，已可以使用 <code>Iterator</code> 中的方法，先看最简单的例子：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 一共6次调用</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>则打印结果是：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

Some(1)
Some(2)
Some(3)
Some(4)
Some(5)
None
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="遍历-iterator"><a href="#遍历-iterator" class="header-anchor">#</a> 遍历 <code>Iterator</code></h4> <p>既然是 <code>Iterator</code> ，则可以使用前面讲到过的各种遍历方法，例如 <code>for</code> ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> counter <span class="token operator">=</span> Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> counter <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>则打印结果是：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

1
2
3
4
5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>又如 <code>map</code> 方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> counter <span class="token operator">=</span> Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> v<span class="token punctuation">:</span>Vec<span class="token operator">&lt;</span>i32<span class="token operator">&gt;</span> <span class="token operator">=</span> counter
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>i<span class="token operator">|</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>打印结果是：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>$ cargo run

[2, 3, 4, 5, 6]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="使用其它方法"><a href="#使用其它方法" class="header-anchor">#</a> 使用其它方法</h4> <p>可以对 <code>Counter</code> 使用其它 <code>Iterator</code> 的方法，例如：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> v<span class="token punctuation">:</span>Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token operator">|</span> a <span class="token operator">*</span> b<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>代码剖析：</p> <ul><li><code>Counter::new()</code> 得到 iterator ，其遍历的值是 <code>1, 2, 3, 4, 5</code></li> <li><code>zip</code> 方法将两份序列化的数据进行组合</li> <li><code>zip</code> 的参数是另一个 iterator ，其遍历的值是 <code>2, 3, 4, 5</code> ，因为使用了 <code>skip(1)</code> ，也就是从第二个 item 开始</li> <li>因此 <code>zip</code> 得到的结果是新的序列化数据，其中的每个 item 是一个 tuple ，也就是 <code>(1,2), (2,3), (3,4), (4,5)</code> ，由于合并的两份数据中 item 个数分别是 5个 和 4个，因此合并结果是 4个</li> <li>接着使用 <code>map</code> ，对应的 Closure 参数就是 tuple ，即 <code>(a, b)</code> ，而 <code>map</code> 得到的新 item 类型是 <code>i32</code> ，值是 <code>a*b</code> ，也就是 <code>2, 6, 12, 20</code></li> <li>再通过 <code>filter</code> 筛选，得到的结果是 <code>6, 12</code></li></ul> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>上面的例子展示了如何为自己的数据类型实现 <code>Iterator</code> 并使用 <code>Iterator</code> 中的方法，从这些例子里可以做出新的总结：</p> <ol><li><code>next</code> 是最基础的方法，因此其功能和所得到的结果也是最原始的，比如，遍历到的 item 是 <code>Some(Item)</code> 类型，如果遍历结束，则得到 <code>None</code> ；遍历结束后再接着遍历，仍然得到 <code>None</code> ；并且，需要根据返回值来自行判断遍历是否结束</li> <li>在 <code>next</code> 基础上实现的其它 <code>Iterator</code> 方法就比较智能，例如 <code>for , map</code> 等方法：第一，会自行判断遍历是否结束；第二，只需要我们处理遍历到的 item，而不需要处理 <code>None</code> ；第三，对于遍历到的 item ，会自动进行解构，直接给我们 <code>Item</code> ，而不是 <code>Some(Item)</code></li> <li>可以看到，<code>next</code> 方法决定了 item 的类型，即 <code>Item</code> ，该类型与实现 <code>Iterator</code> Trait 的数据类型可能是不一样的，例如，<code>Counter</code> 的类型是 struct ，而为其实现的 <code>Iterator</code> 是得到 <code>i32</code> 类型</li> <li>对于 <code>Iterator</code> 的 <em><strong>Produce</strong></em> 方法，可能产生新的 iterator ，例如 <code>map</code> ，参数类型遵从上一个 iterator ，例如 tuple <code>(i32, i32)</code> ，但所产生的新 item 类型取决于 Closure ，例如 <code>i32</code></li> <li>而对于 <code>Iterator</code> 的 <em><strong>Cosume</strong></em> 方法，则只负责收集，因此不会改变所收集的 item 数据类型</li> <li>对于自行实现的 <code>Iterator</code> ，仍然遵循前面内容讲到的所有权机制，因此，对于例子中的 <code>Counter</code> 实例，由于所实现的 <code>Iterator</code> 基于该实例本身，所以可能因为调用过 <code>Iterator</code> 中的某些方法而导致该实例被 move</li></ol> <blockquote><p>例如，使用 <code>for</code> 循环之后，<code>Counter</code> 实例已不可用</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> counter <span class="token operator">=</span> Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// counter已被move给for</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> counter <span class="token punctuation">{</span>
	<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 编译器报错，counter已不可用</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>又如，<code>zip</code> 方法的使用，也导致 <code>Counter</code> 实例不再可用</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> counter <span class="token operator">=</span> Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// counter已被move给zip方法</span>
<span class="token keyword">let</span> v<span class="token punctuation">:</span>Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> counter
    <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>Counter<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token operator">|</span> a <span class="token operator">*</span> b<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 编译器报错，counter已不可用</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/3/2019, 8:13:20 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Rust/Rust_Book_Exp/13 Functional Programming about Closure and Iterator/01 Closures that Anonymous Functions can Capture their Environment.html" class="prev">
        13.1. 匿名函数 Closure
      </a></span> <span class="next"><a href="/Rust/Rust_Book_Exp/13 Functional Programming about Closure and Iterator/03 Improving Our IO Project.html">
        13.3. 改进 minigrep
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b639eb72.js" defer></script><script src="/assets/js/2.5df156af.js" defer></script><script src="/assets/js/69.6f9ff293.js" defer></script>
  </body>
</html>
