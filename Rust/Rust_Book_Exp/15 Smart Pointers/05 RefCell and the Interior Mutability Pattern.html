<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>15.5. 内部可变性 Refcell | Lindorof</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Lindorof's Blog">
    <link rel="preload" href="/assets/css/0.styles.8ac2847d.css" as="style"><link rel="preload" href="/assets/js/app.b639eb72.js" as="script"><link rel="preload" href="/assets/js/2.5df156af.js" as="script"><link rel="preload" href="/assets/js/79.c646997c.js" as="script"><link rel="prefetch" href="/assets/js/10.ee4568ff.js"><link rel="prefetch" href="/assets/js/11.8db0767a.js"><link rel="prefetch" href="/assets/js/12.92a4e660.js"><link rel="prefetch" href="/assets/js/13.e2450b62.js"><link rel="prefetch" href="/assets/js/14.5ae14743.js"><link rel="prefetch" href="/assets/js/15.62a967cf.js"><link rel="prefetch" href="/assets/js/16.3482df63.js"><link rel="prefetch" href="/assets/js/17.881a9d91.js"><link rel="prefetch" href="/assets/js/18.d6e19ee5.js"><link rel="prefetch" href="/assets/js/19.caf0829a.js"><link rel="prefetch" href="/assets/js/20.a80e123c.js"><link rel="prefetch" href="/assets/js/21.9c810086.js"><link rel="prefetch" href="/assets/js/22.bc5f69cb.js"><link rel="prefetch" href="/assets/js/23.f15ef55d.js"><link rel="prefetch" href="/assets/js/24.b8714e3e.js"><link rel="prefetch" href="/assets/js/25.d673c092.js"><link rel="prefetch" href="/assets/js/26.28d57b84.js"><link rel="prefetch" href="/assets/js/27.d8b15b76.js"><link rel="prefetch" href="/assets/js/28.2574be13.js"><link rel="prefetch" href="/assets/js/29.54667d47.js"><link rel="prefetch" href="/assets/js/3.f6602695.js"><link rel="prefetch" href="/assets/js/30.dd697263.js"><link rel="prefetch" href="/assets/js/31.aafbc8db.js"><link rel="prefetch" href="/assets/js/32.5fe2531d.js"><link rel="prefetch" href="/assets/js/33.c3dfca3c.js"><link rel="prefetch" href="/assets/js/34.22613e38.js"><link rel="prefetch" href="/assets/js/35.aad9af2b.js"><link rel="prefetch" href="/assets/js/36.badbd522.js"><link rel="prefetch" href="/assets/js/37.45905373.js"><link rel="prefetch" href="/assets/js/38.ab0de43e.js"><link rel="prefetch" href="/assets/js/39.d1a7492c.js"><link rel="prefetch" href="/assets/js/4.c7710dca.js"><link rel="prefetch" href="/assets/js/40.92c4cb14.js"><link rel="prefetch" href="/assets/js/41.cc19be50.js"><link rel="prefetch" href="/assets/js/42.c9b4b585.js"><link rel="prefetch" href="/assets/js/43.1af966c8.js"><link rel="prefetch" href="/assets/js/44.40ebac1c.js"><link rel="prefetch" href="/assets/js/45.469b8553.js"><link rel="prefetch" href="/assets/js/46.eb491d21.js"><link rel="prefetch" href="/assets/js/47.03d1fbf2.js"><link rel="prefetch" href="/assets/js/48.af296c16.js"><link rel="prefetch" href="/assets/js/49.3a42b55b.js"><link rel="prefetch" href="/assets/js/5.339eb2f5.js"><link rel="prefetch" href="/assets/js/50.ef35a161.js"><link rel="prefetch" href="/assets/js/51.284d50de.js"><link rel="prefetch" href="/assets/js/52.c4983004.js"><link rel="prefetch" href="/assets/js/53.83c193e1.js"><link rel="prefetch" href="/assets/js/54.08f26cd6.js"><link rel="prefetch" href="/assets/js/55.ef20313b.js"><link rel="prefetch" href="/assets/js/56.dc2772cf.js"><link rel="prefetch" href="/assets/js/57.add26447.js"><link rel="prefetch" href="/assets/js/58.ff8f2704.js"><link rel="prefetch" href="/assets/js/59.43fdbc04.js"><link rel="prefetch" href="/assets/js/6.0ce72a94.js"><link rel="prefetch" href="/assets/js/60.1a27c7c3.js"><link rel="prefetch" href="/assets/js/61.9ca63ff6.js"><link rel="prefetch" href="/assets/js/62.9ab09b12.js"><link rel="prefetch" href="/assets/js/63.a6b6d595.js"><link rel="prefetch" href="/assets/js/64.5e9ac56b.js"><link rel="prefetch" href="/assets/js/65.bcfb6015.js"><link rel="prefetch" href="/assets/js/66.5024eb22.js"><link rel="prefetch" href="/assets/js/67.5d83f99f.js"><link rel="prefetch" href="/assets/js/68.80f05874.js"><link rel="prefetch" href="/assets/js/69.6f9ff293.js"><link rel="prefetch" href="/assets/js/7.726c7fbf.js"><link rel="prefetch" href="/assets/js/70.92b749fb.js"><link rel="prefetch" href="/assets/js/71.a4248217.js"><link rel="prefetch" href="/assets/js/72.29aeb940.js"><link rel="prefetch" href="/assets/js/73.8918e90b.js"><link rel="prefetch" href="/assets/js/74.81fd32da.js"><link rel="prefetch" href="/assets/js/75.5357ccc2.js"><link rel="prefetch" href="/assets/js/76.66fc1725.js"><link rel="prefetch" href="/assets/js/77.6f29512b.js"><link rel="prefetch" href="/assets/js/78.a63871cd.js"><link rel="prefetch" href="/assets/js/8.81d630fc.js"><link rel="prefetch" href="/assets/js/80.b5d5ad39.js"><link rel="prefetch" href="/assets/js/81.601aa569.js"><link rel="prefetch" href="/assets/js/82.99bc0640.js"><link rel="prefetch" href="/assets/js/83.06d4defc.js"><link rel="prefetch" href="/assets/js/84.44856307.js"><link rel="prefetch" href="/assets/js/85.3b88ee80.js"><link rel="prefetch" href="/assets/js/86.47c806cb.js"><link rel="prefetch" href="/assets/js/87.b5201cdf.js"><link rel="prefetch" href="/assets/js/88.f9ce8655.js"><link rel="prefetch" href="/assets/js/89.c1f12bf1.js"><link rel="prefetch" href="/assets/js/9.b6118830.js"><link rel="prefetch" href="/assets/js/90.e0f850a2.js"><link rel="prefetch" href="/assets/js/91.8166ca11.js"><link rel="prefetch" href="/assets/js/92.6ba6ce27.js"><link rel="prefetch" href="/assets/js/93.6e09fb58.js"><link rel="prefetch" href="/assets/js/94.1b324565.js"><link rel="prefetch" href="/assets/js/95.5308659f.js"><link rel="prefetch" href="/assets/js/96.306bee11.js"><link rel="prefetch" href="/assets/js/97.6e231fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ac2847d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Lindorof" class="logo"> <span class="site-name can-hide">Lindorof</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/archives.html" class="nav-link">
  文章清单
</a></div><div class="nav-item"><a href="/guide.html" class="nav-link">
  建站指南
</a></div><div class="nav-item"><a href="https://github.com/lindorof" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Rust/Rust_Book_Exp/" aria-current="page" class="sidebar-link">「RustBook」学习心得</a></li><li><a href="/Rust/Rust_Book_Exp/01 Getting Started/01 Getting Started.html" class="sidebar-link">1. 开始</a></li><li><a href="/Rust/Rust_Book_Exp/02 Programming a Guessing Game/01 Programming a Guessing Game.html" class="sidebar-link">2. 猜谜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3. 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>4. 所有权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>5. 结构体</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>6. 枚举</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>7. 模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>8. 集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>9. 错误处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>10. 泛型及生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>11. 自动测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>12. 命令行</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>13. 闭包及迭代器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>14. Cargo 和 Crates.io</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>15. 智能指针</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/00 Foreword.html" class="sidebar-link">15.0. 前言</a></li><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/01 Using Box to Point to Data on the Heap.html" class="sidebar-link">15.1. 使用 Box</a></li><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/02 Treating Smart Pointers Like Regular References with the Deref Trait.html" class="sidebar-link">15.2. 详解 Deref &amp; DerefMut</a></li><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/03 Running Code on Cleanup with the Drop Trait.html" class="sidebar-link">15.3. 使用 Drop 清理资源</a></li><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/04 Rc the Reference Counted Smart Pointer.html" class="sidebar-link">15.4. 使用 Rc 引用计数</a></li><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/05 RefCell and the Interior Mutability Pattern.html" class="active sidebar-link">15.5. 内部可变性 Refcell</a></li><li><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/06 Reference Cycles Can Leak Memory.html" class="sidebar-link">15.6. 循环引用</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>16. 无畏并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>17. 面向对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>18. 模式与匹配</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>19. 高级特征</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_15-5-内部可变性-refcell"><a href="#_15-5-内部可变性-refcell" class="header-anchor">#</a> 15.5. 内部可变性 <code>Refcell</code></h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <h3 id="引言"><a href="#引言" class="header-anchor">#</a> 引言</h3> <ul><li><em><strong>内部可变性</strong></em>（<em><strong>Interior mutability</strong></em>）是 rust 的一个设计模式</li> <li>它允许你改变数据，即使该数据是 <em><strong>不可变</strong></em> 引用</li> <li>但是，rust <em><strong>编译时</strong></em> 不允许这样的规则，因此，<em><strong>Interior mutability</strong></em> 是 <em><strong>运行时</strong></em> 实现的</li> <li><em><strong>内部可变性</strong></em> 的实现需要 <code>unsafe</code> 代码，在 Chapter19 会讲解</li> <li>rust 是 <em><strong>保守</strong></em> 的：
<ol><li>rust 的 <em><strong>所有权规则</strong></em> ：
<ul><li>引用必须总是有效的</li> <li>任何时候，只能拥有一个可变引用，或者多个不可变引用，二选一</li></ul></li> <li>rust 要求在 <em><strong>编译时</strong></em> 满足所有权规则，也就是 <em><strong>静态分析</strong></em></li> <li>所以，相比在 <em><strong>运行时</strong></em> 进行所有权规则检查，<em><strong>编译时</strong></em> 可能会拒绝一些正确的程序</li> <li>但是，拒绝正确的程序，只是 rust 的 <em><strong>保守</strong></em> ，而接受错误的程序，就是 <em><strong>灾难</strong></em></li> <li>因此，rust 选择了在 <em><strong>编译时</strong></em> 对所有权规则进行检查，好处是：在开发过程中就发现问题，而不影响运行时性能</li></ol></li></ul> <h3 id="refcell-的产生"><a href="#refcell-的产生" class="header-anchor">#</a> <code>RefCell</code> 的产生</h3> <ul><li><code>RefCell</code> 实现了 <em><strong>内部可变性</strong></em> 这种设计模式</li> <li>它能够确保 rust 编译通过，同时在 <em><strong>运行时</strong></em> 进行所有权规则检查</li> <li>简单来说，就是 <em><strong>编译时</strong></em> 确定下来的所有权规则（例如非 mut），能够在 <em><strong>运行时</strong></em> 进行改变（改变为 mut）</li> <li>但要注意的是，不管 <em><strong>编译时</strong></em> 和 <em><strong>运行时</strong></em> ，都满足 rust 的 <em><strong>所有权规则</strong></em></li></ul> <h3 id="box-rc-refcell"><a href="#box-rc-refcell" class="header-anchor">#</a> <code>Box</code> &amp; <code>Rc</code> &amp; <code>RefCell</code></h3> <blockquote><p>注意：下述讨论针对的是「所存储的数据」，而不是 <code>Box</code> / <code>Rc</code> / <code>RefCell</code> 这些「实例」</p></blockquote> <p>所有者：</p> <ul><li><code>Box</code> 只能有一个所有者，这个所有者就是 <code>Box</code> 实例本身</li> <li><code>RefCell</code> 也只能有一个所有者，这个所有者就是 <code>RefCell</code> 实例本身</li> <li><code>Rc</code> 可以同时存在多个所有者，使用 <code>Rc::new</code> 来创建实例，使用 <code>Rc::clone</code> 来产生新的所有者</li></ul> <p>可变性：</p> <ul><li><code>Rc</code> 只能获得 不可变性</li> <li><code>Box</code> 可以通过 <code>Deref</code> / <code>DerefMut</code> 获得 可变性/不可变性</li> <li><code>RefCell</code> 通过提供的方法可以获得 可变性/不可变性</li></ul> <p>检查时机：</p> <ul><li><code>Box</code> 由编译器检查，在编译时进行</li> <li><code>Rc</code> 由编译器检查，在编译时进行</li> <li><code>RefCell</code> 在运行时检查，所以需使用 <code>unsafe</code> 代码</li></ul> <p>线程场景：</p> <ul><li><code>Rc</code> 和 <code>RefCell</code> 都只能用于单线程场景</li> <li>因为 <code>Rc</code> 在运行时要维护引用计数，维护资源的清理时机，多线程下会导致计数和销毁错误</li> <li>同时 <code>RefCell</code> 在运行时要维护可变/不可变 规则，多线程下会导致错误</li></ul> <p>所有权规则：</p> <ul><li>不管 <em><strong>编译时</strong></em> 和 <em><strong>运行时</strong></em> ，都满足 rust 的所有权规则</li> <li>区别只是 <em><strong>检查的时机</strong></em></li> <li>如果违反了所有权规则，则 <em><strong>编译时</strong></em> 提示编译错误，而 <em><strong>运行时</strong></em> 则程序 <code>panic!</code></li></ul> <p>总结：</p> <ul><li>它们都是一种自定义数据类型，目的是用来存储和维护数据</li> <li>所以，这里有两个概念：对应类型的实例 obj 、实例中所存储的数据 data</li> <li>因此，obj 依然是满足 <em><strong>编译时</strong></em> 的 rust 所有权规则</li> <li>同时，data 则通过这些类型和方法的封装，在 <em><strong>编译时</strong></em> 或 <em><strong>运行时</strong></em> 具备了不同的行为</li></ul> <h2 id="详解-refcell"><a href="#详解-refcell" class="header-anchor">#</a> 详解 <code>RefCell</code></h2> <h3 id="问题回顾"><a href="#问题回顾" class="header-anchor">#</a> 问题回顾</h3> <p>下面是一个最简单的例子，回顾一下 rust 的所有权规则：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> x<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>则编译错误提示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token builtin class-name">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span>mut x<span class="token punctuation">;</span>
    ^^^^^^ cannot borrow as mutable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>错误剖析：</p> <ul><li>已经有一个不可变值，即 x</li> <li>所以，不能再 <code>&amp;mut</code> 方式借用该值</li> <li>因为 <code>&amp;mut x</code> 会改变 x 的可变性</li></ul> <p>解决方式：</p> <ul><li>也就是说，一旦数据确定了可变性，则后续都不允许改变这种可变性</li> <li>这个规则是 rust 编译器在编译时的行为，否则该程序就不被 rust 编译器所接受</li> <li>而 <code>RefCell</code> 的作用，就是允许在运行时来改变这种可变性</li></ul> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h3> <p>使用方式：</p> <ul><li>使用 <code>RefCell::new(x)</code> 创建一个实例，存储数据 x</li> <li>使用 <code>borrow()</code> 得到数据 x 的 非 mut 引用</li> <li>使用 <code>borrow_mut()</code> 方法得到数据 x 的 mut 引用</li></ul> <p>本质：</p> <ul><li><code>borrow()</code> 得到的是 <code>std::cell::Ref</code> 类型的智能指针</li> <li><code>borrow_mut()</code> 得到的是 <code>std::cell::RefMut</code> 类型的智能指针</li> <li>而 <code>std::cell::Ref</code> 和 <code>std::cell::RefMut</code> 这两个智能指针都实现了 <code>Deref</code> 这个 trait</li></ul> <p>举例：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 创建一个 RefCell 实例</span>
<span class="token comment">// 该实例存储一个 i32 数据</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 得到数据的非 mut 引用并打印</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 得到数据的 mut 引用并改变其内容</span>
<span class="token comment">// 注意这里需要使用 * 来解引用</span>
<span class="token operator">*</span>y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

<span class="token comment">// 再次得到数据的非 mut 引用并打印</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>打印结果是：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">5</span>
<span class="token number">6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>剖析：</p> <ul><li>上面的代码对一个 <code>i32</code> 数据进行操作</li> <li>对该 <code>i32</code> 数据，有 mut 引用，同时也有非 mut 引用</li> <li>如果不使用 <code>RefCell</code> ，则编译器是不接受这样的操作的</li> <li>但是通过 <code>RefCell</code> ，我们在运行时实现了这样的操作</li></ul> <h3 id="运行时检查"><a href="#运行时检查" class="header-anchor">#</a> 运行时检查</h3> <p>检查规则：</p> <ul><li><code>RefCell</code> 会在 <em><strong>运行时</strong></em> 记录当前有多少个 <em><strong>活动的</strong></em> <code>std::cell::Ref</code> 和 <code>std::cell::RefMut</code> 智能指针</li> <li>在调用 <code>borrow()</code> 或 <code>borrow_mut()</code> 时，<code>RefCell</code> 会分别将 <code>Ref</code> 或 <code>RefMut</code> 的计数加一，而当 <code>Ref</code> 或 <code>RefMut</code> 离开生存范围时，对应计数减一</li> <li>而所有权规则与 <em><strong>编译时</strong></em> 一样，在任何时候，只能拥有一个可变引用，或者多个不可变引用，二选一</li></ul> <h4 id="举例：不允许同时存在-和-mut"><a href="#举例：不允许同时存在-和-mut" class="header-anchor">#</a> 举例：不允许同时存在 <code>&amp;</code> 和 <code>&amp;mut</code></h4> <p>注意看注释：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 创建 RefCell 实例</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 得到 &amp;mut</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> m1 <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 得到 &amp; ，但是此时 m1 这个 &amp;mut 仍然存在</span>
<span class="token comment">// 因此这句代码会导致运行时 panic!</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>编译正确，但运行时 <code>panic!</code> ：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>panicked at <span class="token string">'already mutably borrowed: BorrowError'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以改一下这段代码，先将 <code>m1</code> 提前销毁，再获取 <code>&amp;</code> ，则运行正确：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> y <span class="token operator">=</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> m1 <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 销毁 m1</span>
<span class="token comment">// 因此 &amp;mut 计数为 0</span>
<span class="token function">drop</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 此时可以获取 &amp;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="举例：不允许同时存在多个-mut"><a href="#举例：不允许同时存在多个-mut" class="header-anchor">#</a> 举例：不允许同时存在多个 <code>&amp;mut</code></h4> <p>代码如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> y <span class="token operator">=</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> m1 <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> m2 <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>便以正确，但运行时 <code>panic!</code> ：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>panicked at <span class="token string">'already borrowed: BorrowMutError'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以改一下这段代码，现将 <code>m1</code> 提前销毁，再获取 <code>&amp;mut</code> ，则运行正确：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> y <span class="token operator">=</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> m1 <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">drop</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> m2 <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="结合-rc-refcell"><a href="#结合-rc-refcell" class="header-anchor">#</a> 结合 <code>Rc</code> &amp; <code>RefCell</code></h2> <h3 id="规则"><a href="#规则" class="header-anchor">#</a> 规则</h3> <ul><li><code>Rc</code> 可以让多个所有者来拥有同一份数据</li> <li><code>RefCell</code> 可以在运行时改变数据的可变性，但是该数据只能有一个所有者，也就是 <code>RefCell</code> 实例本身</li> <li>因此，结合 <code>Rc</code> 和 <code>RefCell</code> ，就可以实现：
<ol><li>对于同一份数据，可以存在多个所有者</li> <li>这些所有者都可以在运行时改变该数据的可变性</li></ol></li></ul> <h3 id="举例"><a href="#举例" class="header-anchor">#</a> 举例</h3> <p>看下面的例子，并注意看注释：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 用 RefCell 存储数据 5</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// b 和 c 都拥有了数据 5</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> c <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// b 将数据修改为 6</span>
<span class="token operator">*</span>b<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// c 将数据修改为 7</span>
<span class="token operator">*</span>c<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>该例子编译正确，也运行正确：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>RefCell <span class="token punctuation">{</span> value: <span class="token number">5</span> <span class="token punctuation">}</span>
RefCell <span class="token punctuation">{</span> value: <span class="token number">6</span> <span class="token punctuation">}</span>
RefCell <span class="token punctuation">{</span> value: <span class="token number">7</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="改进-cons"><a href="#改进-cons" class="header-anchor">#</a> 改进 <code>Cons</code></h3> <p>继续改进之前使用的 <code>Cons</code> 例子，注意看注释：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> RList <span class="token punctuation">{</span>
    <span class="token comment">// i32 可以有多个所有者，且可以运行时被改变</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>i32<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> Rc<span class="token operator">&lt;</span>RList<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> RList<span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span>Rc<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span>RefCell<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// value 被 a、b、c 共享</span>
    <span class="token comment">// a 又被 b、c 共享</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Rc<span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更改 value 的值 </span>
    <span class="token operator">*</span>value<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">50</span><span class="token punctuation">;</span>

    <span class="token comment">// 则 a、b、c 里面的值也都被改变</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a = {:?}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b = {:?}&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;c = {:?}&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>该例子编译正确，也运行正确：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>a <span class="token operator">=</span> Cons<span class="token punctuation">(</span>RefCell <span class="token punctuation">{</span> value: <span class="token number">55</span> <span class="token punctuation">}</span>, Nil<span class="token punctuation">)</span>
b <span class="token operator">=</span> Cons<span class="token punctuation">(</span>RefCell <span class="token punctuation">{</span> value: <span class="token number">100</span> <span class="token punctuation">}</span>, Cons<span class="token punctuation">(</span>RefCell <span class="token punctuation">{</span> value: <span class="token number">55</span> <span class="token punctuation">}</span>, Nil<span class="token punctuation">))</span>
c <span class="token operator">=</span> Cons<span class="token punctuation">(</span>RefCell <span class="token punctuation">{</span> value: <span class="token number">200</span> <span class="token punctuation">}</span>, Cons<span class="token punctuation">(</span>RefCell <span class="token punctuation">{</span> value: <span class="token number">55</span> <span class="token punctuation">}</span>, Nil<span class="token punctuation">))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="mock-object"><a href="#mock-object" class="header-anchor">#</a> Mock Object</h2> <h3 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h3> <ul><li><em><strong>test double</strong></em> 是一种通用的编程概念</li> <li>它表示一种类型，用于替代所要测试的那个真实类型</li> <li>而 <em><strong>mock object</strong></em> 就是 <em><strong>test double</strong></em> 的一种特定类型</li> <li>关于 <em><strong>mock object</strong></em> 详情，可以单独学习，不是本书的内容</li> <li>rust 没有内建的 <em><strong>mock object</strong></em> ，但我们可以来模仿该功能，并且会使用到 <code>RefCell</code></li></ul> <h3 id="场景剖析"><a href="#场景剖析" class="header-anchor">#</a> 场景剖析</h3> <p>首先我们开发了一个功能 <code>NotifySth</code>：</p> <ul><li><code>NotifySth</code> 的功能是，接收一个数值，并判断该数值比 100 大还是 比 100 小（不要介意这个弱智的功能，目的只是要演示 <code>RefCell</code> 的用途）</li> <li>如果比 100 大，则发出「消息」，这个「消息」体现为字符串</li></ul> <p>其次，需要「消息接收者」<code>Messenger</code> ：</p> <ul><li><code>Messenger</code> 用来接收消息</li> <li>同时，<code>NotifySth</code> 只负责传递消息给 <code>Messenger</code> ，而不关注 <code>Messenger</code> 对消息会进行何种处理，例如发送短信，或者发送邮件</li></ul> <p>因此，问题来了：</p> <ul><li>为了测试 <code>NotifySth</code> ，我们就需要 <code>Messenger</code></li> <li>但是，可能 <code>Messenger</code> 的环境太复杂，会实际发送短信或邮件，测试环境不一定能满足发短信/邮件的条件</li> <li>而我们关注的测试点是：<code>NotifySth</code> 是否发出了「消息」；而不是关注短信或邮件有没有发送成功</li> <li>所以，我们就需要 <strong>mock object</strong> ，来替代 <code>Messenger</code> 的功能，从而达到测试 <code>NotifySth</code> 的目的</li></ul> <h3 id="场景实现"><a href="#场景实现" class="header-anchor">#</a> 场景实现</h3> <blockquote><p>首先，需要将 <code>Messenger</code> 定义为 trait ：</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> Messenger <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：</p> <ul><li>该 trait 的方法是 <code>send</code> ，通过调用该方法，实现消息的传递</li> <li>我们只关注消息能够传递，而不关注是该消息是如何被处理的</li> <li>因此，我们只应该将形参声明为 <code>&amp;self</code> ，而不是 <code>&amp;mut self</code></li> <li>所以，对于 <code>&amp;self</code> ，可以接受 <code>&amp;mut obj</code> 的实参，也能接收 <code>&amp; obj</code> 的实参</li> <li>也就是说，<code>&amp;self</code> 这种形参（功能的提供者），对于实参（功能的使用者）的可变性没有要求</li></ul> <blockquote><p>其次，实现 <code>NotifySth</code> ，具体参见注释：</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> NotifySth<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a,</span> T<span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'a</span> <span class="token operator">+</span> Messenger<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存「消息接收者」</span>
    messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> T<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a,</span> T<span class="token punctuation">:</span> Messenger<span class="token operator">&gt;</span> NotifySth<span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a,</span> T<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span>T<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> NotifySth<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        NotifySth <span class="token punctuation">{</span> messenger <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">check_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> value <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若大于100则发送消息给「接收者」</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;value is greater than 100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>然后，为了测试 <code>NotifySth</code> ，我们需要为 <code>Messenger</code> 实现一个 mock object ：</p></blockquote> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token comment">// 这就是 mock object</span>
    <span class="token keyword">struct</span> MockMessenger <span class="token punctuation">{</span>
        <span class="token comment">// 它存储着消息列表</span>
        msg_list<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> MockMessenger <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> MockMessenger <span class="token punctuation">{</span>
            MockMessenger <span class="token punctuation">{</span> msg_list<span class="token punctuation">:</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> Messenger <span class="token keyword">for</span> MockMessenger <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 它接收到消息以后，将消息存储到列表</span>
            <span class="token comment">// 但这句代码是编译不通过的，因为不是 &amp;mut self</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>msg_list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function">greater_than_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mm <span class="token operator">=</span> MockMessenger<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        NotifySth<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check_value</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>mm<span class="token punctuation">.</span>msg_list<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>针对上面的问题，就可以使用 <code>RefCell</code> ：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span>RefCell<span class="token punctuation">;</span>

    <span class="token comment">// 这就是 mock object</span>
    <span class="token keyword">struct</span> MockMessenger <span class="token punctuation">{</span>
        <span class="token comment">// 使用 RefCell 来存储 Vec</span>
        msg_list<span class="token punctuation">:</span> RefCell<span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>String<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> MockMessenger <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> MockMessenger <span class="token punctuation">{</span>
            <span class="token comment">// 创建 RefCell 实例来存储 Vec</span>
            MockMessenger <span class="token punctuation">{</span> msg_list<span class="token punctuation">:</span> RefCell<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> Messenger <span class="token keyword">for</span> MockMessenger <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过 borrow_mut() 来获得 Vec 的可变引用</span>
            <span class="token comment">// 从而实现在 Vec 中加入消息</span>
            <span class="token comment">// 这样的话，就不需要 &amp;mut self</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>msg_list<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>String<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function">greater_than_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mm <span class="token operator">=</span> MockMessenger<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        NotifySth<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check_value</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过 borrow() 来获得 Vec 的不可变引用</span>
        <span class="token function">assert_eq!</span><span class="token punctuation">(</span>mm<span class="token punctuation">.</span>msg_list<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="后记"><a href="#后记" class="header-anchor">#</a> 后记</h2> <h3 id="权衡-refcell"><a href="#权衡-refcell" class="header-anchor">#</a> 权衡 <code>RefCell</code></h3> <ul><li><p><code>RefCell</code> 在 <em><strong>运行时</strong></em> 而不是 <em><strong>编译时</strong></em> 进行所有权规则的检查</p></li> <li><p>这意味着有些错误可能在开发后期、甚至是生产环境上才能被发现</p></li> <li><p>而且，<em><strong>运行时检查</strong></em> 还会带来一定程度的运行时性能损耗</p></li> <li><p>但是，<code>RefCell</code> 带来了比常规引用更多的功能，比如 <em><strong>内部可变性</strong></em></p></li></ul> <h3 id="其它类型"><a href="#其它类型" class="header-anchor">#</a> 其它类型</h3> <ul><li><p>rust 标准库除了 <code>RefCell</code> ，还有 <code>Cell</code> ，它们都实现了  <em><strong>内部可变性</strong></em> ，区别是：</p> <ol><li><code>RefCell</code> 对外提供数据时，是 <em><strong>引用</strong></em> ，即 <code>&amp;</code> 或 <code>&amp;mut</code></li> <li><code>Cell</code> 对外提供数据时，是 <em><strong>拷贝</strong></em> ，而 <em><strong>浅拷贝(Move机制)</strong></em> 或 <em><strong>深拷贝(Copy特性)</strong></em> ，则取决于具体的数据类型（<em>参考 Chapter4 的所有权讲解</em>）</li></ol></li> <li><p>rust 标准库还提供了 <code>Mutex</code> ：</p> <ol><li><code>Mutex</code> 也实现了  <em><strong>内部可变性</strong></em></li> <li>但是 <code>Rc</code> 和 <code>RefCell</code> 都只能用于单线程场景</li> <li>而 <code>Mutex</code> 可以使用于多线程场景</li> <li>Chapter16 会详细讨论 <code>Mutex</code></li></ol></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/20/2019, 2:23:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Rust/Rust_Book_Exp/15 Smart Pointers/04 Rc the Reference Counted Smart Pointer.html" class="prev">
        15.4. 使用 Rc 引用计数
      </a></span> <span class="next"><a href="/Rust/Rust_Book_Exp/15 Smart Pointers/06 Reference Cycles Can Leak Memory.html">
        15.6. 循环引用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b639eb72.js" defer></script><script src="/assets/js/2.5df156af.js" defer></script><script src="/assets/js/79.c646997c.js" defer></script>
  </body>
</html>
