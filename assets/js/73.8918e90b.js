(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{467:function(s,a,t){"use strict";t.r(a);var n=t(27),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_14-3-cargo-工作空间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_14-3-cargo-工作空间"}},[s._v("#")]),s._v(" 14.3. Cargo 工作空间")]),s._v(" "),t("p",[t("em",[s._v("源码："),t("a",{attrs:{href:"https://gitee.com/lindorof/Rust_The_Book/tree/master/ch14-3-add-ws",target:"_blank",rel:"noopener noreferrer"}},[s._v("ch14-3-add-ws"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("在 Chapter12 ，我们创建了一个软件包，包含了 binary crate 和 library crate 。而在项目开发过程中，library crate 可能会变得越来越大，你想将软件包进一步拆分为多个 library crate 。针对这种情况，Cargo 提供了一个特性叫做 "),t("em",[t("strong",[s._v("workspace")])]),s._v(" ，它能管理多个相关联的协作开发的软件包。")]),s._v(" "),t("h2",{attrs:{id:"创建-workspace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建-workspace"}},[s._v("#")]),s._v(" 创建 Workspace")]),s._v(" "),t("p",[s._v("何为 workspace ：")]),s._v(" "),t("ul",[t("li",[s._v("是一系列软件包的合集")]),s._v(" "),t("li",[s._v("这些软件包都共用一个 "),t("code",[s._v("Cargo.lock")])]),s._v(" "),t("li",[s._v("这些软件包使用同一个输出目录")])]),s._v(" "),t("p",[s._v("下面开始来创建一个 workspace ，包含两个 binary 和两个 library ：")]),s._v(" "),t("ul",[t("li",[s._v("binary 实现主要功能和逻辑，并依赖于另外两个 library ，crate 名称是 "),t("code",[s._v("adder")])]),s._v(" "),t("li",[s._v("一个 library 实现了 "),t("code",[s._v("add_one")]),s._v(" 函数，crate 名称是 "),t("code",[s._v("add-one")])]),s._v(" "),t("li",[s._v("另一个 library 实现了 "),t("code",[s._v("add_two")]),s._v(" 函数，crate 名称是 "),t("code",[s._v("add-two")])]),s._v(" "),t("li",[s._v("整个 workspace 的名称叫 "),t("code",[s._v("add-ws")])])]),s._v(" "),t("p",[s._v("首先为 workspace 创建目录：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" add-ws\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" add-ws\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("然后在 "),t("code",[s._v("add-ws")]),s._v(" 目录中，添加 "),t("code",[s._v("Cargo.toml")]),s._v(" 来配置 workspace ：")]),s._v(" "),t("ul",[t("li",[s._v("不需要有 "),t("code",[s._v("[package]")]),s._v(" 、metadata 等信息")]),s._v(" "),t("li",[s._v("而是需要 "),t("code",[s._v("[workspace]")]),s._v(" 来配置该工作空间中有哪些成员")]),s._v(" "),t("li",[s._v("因此，需要在 "),t("code",[s._v("[workspace]")]),s._v(" 中配置各个 crate 的路径")])]),s._v(" "),t("p",[s._v("现在先指定 binary crate 的路径：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / Cargo.toml")])]),s._v(" "),t("div",{staticClass:"language-toml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-toml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("workspace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("members")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"adder"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("对应的，在 "),t("code",[s._v("add-ws")]),s._v(" 目录下创建 "),t("code",[s._v("adder")]),s._v(" 这个 binary crate ：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo new adder\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("此时在 "),t("code",[s._v("add-ws")]),s._v(" 目录上执行 "),t("code",[s._v("cargo build")]),s._v(" ，则整个目录结构如下：")]),s._v(" "),t("div",{staticClass:"language-mermaid line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("graph LR\n\nADD[add-ws]\nADD --\x3e CL(Cargo.lock)\nADD --\x3e CT(Cargo.toml)\nADDER[adder]\nADD --\x3e ADDER\nADDER --\x3e ADDERCT(Cargo.toml)\nADDERSRC[src]\nADDER --\x3e ADDERSRC\nADDERSRC --\x3e ADDERMAIN(main.rs)\nADD -.-> TGT[target]\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("目录结构说明：")]),s._v(" "),t("ol",[t("li",[s._v("在 "),t("code",[s._v("add-ws")]),s._v(" 这个 workspace 的根目录下，有 "),t("code",[s._v("target")]),s._v(" 目录来存放构建结果")]),s._v(" "),t("li",[s._v("对 workspace 中的各个 crate 来说，例如 "),t("code",[s._v("adder")]),s._v(" ，不会再有自己的 "),t("code",[s._v("target")]),s._v(" 目录")]),s._v(" "),t("li",[s._v("即使在 "),t("code",[s._v("adder")]),s._v(" 目录上执行 "),t("code",[s._v("cargo build")]),s._v(" ，构建结果也是在 "),t("code",[s._v("add-ws/target")]),s._v(" 中，而不会在 "),t("code",[s._v("add-ws/adder/target")]),s._v(" 中")]),s._v(" "),t("li",[s._v("Cargo 之所以让整个 workspace 共享一个 "),t("code",[s._v("target")]),s._v(" ，是因为该 workspace 中的各个 crate 是相互依赖的，从而在编译某个 crate 时，不需要考虑同时编译所依赖的其它 crate")])]),s._v(" "),t("h2",{attrs:{id:"添加其它-crate"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加其它-crate"}},[s._v("#")]),s._v(" 添加其它 Crate")]),s._v(" "),t("p",[s._v("现在需要为 workspace 添加另一个 library crate ，也就是 "),t("code",[s._v("add-one")]),s._v(" ，因此，需要在 workspace 的 "),t("code",[s._v("Cargo.toml")]),s._v(" 中配置对应的路径：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / Cargo.toml")])]),s._v(" "),t("div",{staticClass:"language-toml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-toml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("workspace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("members")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"adder"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"add-one"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("然后创建对应的 "),t("code",[s._v("add-one")]),s._v(" 这个 library crate ：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo new add-one --lib\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("此时整个 workspace 目录结构如下：")]),s._v(" "),t("div",{staticClass:"language-mermaid line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("graph LR\n\nADD[add-ws]\nADD --\x3e CL(Cargo.lock)\nADD --\x3e CT(Cargo.toml)\nADDER[adder]\nADD --\x3e ADDER\nADDER --\x3e ADDERCT(Cargo.toml)\nADDERSRC[src]\nADDER --\x3e ADDERSRC\nADDERSRC --\x3e ADDERMAIN(main.rs)\nADDONE[add-one]\nADDONE --\x3e ADDONECT(Cargo.toml)\nADDONESRC[src]\nADDONE --\x3e ADDONESRC\nADDONESRC --\x3e ADDERONELIB(lib.rs)\nADD --\x3e ADDONE\nADD -.-> TGT[target]\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("接着为该 library crate 添加函数：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / add-one / src / lib.rs")])]),s._v(" "),t("div",{staticClass:"language-rust line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-rust"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pub")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fn")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_one")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" i32"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("->")]),s._v(" i32 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("然后让 "),t("code",[s._v("adder")]),s._v(" 这个 binary crate 依赖和使用 "),t("code",[s._v("add-one")]),s._v(" 这个 library crate ：")]),s._v(" "),t("ul",[t("li",[s._v("Cargo 并不知道 workspace 中各个 crate 的相互依赖关系，因此，若 "),t("code",[s._v("adder")]),s._v(" 依赖和使用了 "),t("code",[s._v("add-one")]),s._v(" ，则需要在 "),t("code",[s._v("adder")]),s._v(" 的 "),t("code",[s._v("Cargo.toml")]),s._v(" 中自行配置该依赖关系")]),s._v(" "),t("li",[s._v("依赖配置项位于 "),t("code",[s._v("[dependencies]")]),s._v(" 中，配置方式是 "),t("code",[s._v('add-one = { path = "../add-one" }')])]),s._v(" "),t("li",[s._v("要注意的是，其中的 "),t("code",[s._v("path")]),s._v(" 要注明路径，而不仅仅是 "),t("code",[s._v("add-one")]),s._v(" 这个名称，因此， "),t("code",[s._v("../add-one")]),s._v(" 表明位置在上一层目录")]),s._v(" "),t("li",[s._v("对应的，在 "),t("code",[s._v("adder")]),s._v(" 中，使用 "),t("code",[s._v("add-one")]),s._v(" 之前，需要先 "),t("code",[s._v("use")])])]),s._v(" "),t("p",[s._v("下面是代码示例：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / adder / Cargo.toml")])]),s._v(" "),t("div",{staticClass:"language-toml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-toml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("dependencies")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("add-one")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("path")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../add-one"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("p",[s._v("add-ws / adder / src / main.rs")])]),s._v(" "),t("div",{staticClass:"language-rust line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-rust"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" add_one"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fn")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println!")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"add_one({})={}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" add_one"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("::")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_one")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("然后构建整个 workspace ：")]),s._v(" "),t("ul",[t("li",[s._v("直接在 "),t("code",[s._v("add-ws")]),s._v(" 目录上运行 "),t("code",[s._v("cargo build")])]),s._v(" "),t("li",[s._v("可以看到整个 workspace 中的所有 crate 都进行了构建")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo build\n   Compiling add-one v0.1.0\n   Compiling adder v0.1.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("最后可以运行程序：")]),s._v(" "),t("ul",[t("li",[s._v("直接在 "),t("code",[s._v("add-ws")]),s._v(" 目录上运行 "),t("code",[s._v("cargo run")])]),s._v(" "),t("li",[s._v("如果 workspace 中只有一个 binary crate ，则 Cargo 会默认找到并运行它，即 "),t("code",[s._v("adder")])]),s._v(" "),t("li",[s._v("如果 workspace 中有多个 binary crate ，则需要使用 "),t("code",[s._v("-p")]),s._v(" 来指定，例如 "),t("code",[s._v("cargo run -p adder")])])]),s._v(" "),t("p",[s._v("执行示例如下：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo run\nadd_one"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo run -p adder\nadd_one"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"依赖外部-crate"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#依赖外部-crate"}},[s._v("#")]),s._v(" 依赖外部 Crate")]),s._v(" "),t("p",[s._v("注意 workspace 中对各个 crate 的依赖处理：")]),s._v(" "),t("ol",[t("li",[s._v("在整个 workspace 中，只有最外层目录中有一个 "),t("code",[s._v("Cargo.lock")]),s._v(" ，而在各个 crate 目录中并没有 "),t("code",[s._v("Cargo.lock")]),s._v(" ，观察上述的目录结构也可以看到这一点")]),s._v(" "),t("li",[s._v("这就确保了对于某个依赖项来说，在整个 workspace 中只会有一个版本，也就是说，各个 crate 使用到的该依赖项属于同一个版本")]),s._v(" "),t("li",[s._v("例如，在 "),t("code",[s._v("adder/Cargo.toml")]),s._v(" 和 "),t("code",[s._v("add-one/Cargo.toml")]),s._v(" 中都增加 "),t("code",[s._v("rand")]),s._v(" 这个 crate ，则 Cargo 会解析为同一个 "),t("code",[s._v("rand")]),s._v(" 版本并记录在 "),t("code",[s._v("Cargo.lock")]),s._v(" 中")]),s._v(" "),t("li",[s._v("这个机制保证了 workspace 中的各个 crate 是相互兼容的")])]),s._v(" "),t("p",[s._v("例如，为 "),t("code",[s._v("add-one")]),s._v(" 添加 "),t("code",[s._v("rand")]),s._v(" 依赖：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / add-one / Cargo.toml")])]),s._v(" "),t("div",{staticClass:"language-toml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-toml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("dependencies")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("rand")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.3.14"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("同样的，如果 "),t("code",[s._v("adder")]),s._v(" 中也需要使用 "),t("code",[s._v("rand")]),s._v(" ，则仍然需要单独添加：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / adder / Cargo.toml")])]),s._v(" "),t("div",{staticClass:"language-toml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-toml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("dependencies")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("add-one")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("path")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../add-one"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key property"}},[s._v("rand")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.3.14"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("然后在 "),t("code",[s._v("add-ws")]),s._v(" 目录上执行 "),t("code",[s._v("Carogo build")]),s._v(" ：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo build\n\nDownloading rand v0.3.14\nCompiling rand v0.3.14\nCompiling add-one\nCompiling adder\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("再次总结：")]),s._v(" "),t("ol",[t("li",[s._v("在 workspace 中，对于要使用的依赖项，每个 crate 需要自行在对应的 "),t("code",[s._v("Cargo.toml")]),s._v(" 中添加，某个 crate 使用了依赖项 A ，并不表示另一个 crate 就可以使用该依赖项")]),s._v(" "),t("li",[s._v("即使多个 crate 使用了同一个依赖项，Cargo 最后也会解析为同一个版本的同一个依赖项")]),s._v(" "),t("li",[s._v("即使多个 crate 使用了同一个依赖项，Cargo 也只会下载和构建一次该依赖项")]),s._v(" "),t("li",[s._v("该机制确保了 workspace 中的多个 crate 相互兼容")])]),s._v(" "),t("h2",{attrs:{id:"测试和发布"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试和发布"}},[s._v("#")]),s._v(" 测试和发布")]),s._v(" "),t("p",[s._v("测试规则：")]),s._v(" "),t("ul",[t("li",[s._v("在 workspace 上运行 "),t("code",[s._v("Cargo test")]),s._v(" ，则会测试 workspace 中的所有 crate")]),s._v(" "),t("li",[s._v("如果只想测试某个 crate ，则可以使用 "),t("code",[s._v("Cargo test -p xxx")]),s._v(" 来指定要测试的 crate 名称")])]),s._v(" "),t("p",[s._v("发布规则：")]),s._v(" "),t("ul",[t("li",[s._v("workspace 中的各个 crate 需要分开单独发布")]),s._v(" "),t("li",[s._v("因为 "),t("code",[s._v("cargo publish")]),s._v(" 没有 诸如 "),t("code",[s._v("--all")]),s._v(" 或 "),t("code",[s._v("-p")]),s._v(" 等选项")]),s._v(" "),t("li",[s._v("所以需要进入各个 crate 目录，单独执行 "),t("code",[s._v("cargo publish")]),s._v(" 来发布该 crate")])]),s._v(" "),t("p",[s._v("例如，为 "),t("code",[s._v("add-one")]),s._v(" 添加一个测试：")]),s._v(" "),t("blockquote",[t("p",[s._v("add-ws / add-one / src / lib.rs")])]),s._v(" "),t("div",{staticClass:"language-rust line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-rust"}},[t("code",[t("span",{pre:!0,attrs:{class:"token attribute attr-name"}},[s._v("#[cfg(test)]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mod")]),s._v(" tests "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("super")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("::")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token attribute attr-name"}},[s._v("#[test]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fn")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("it_works")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("assert_eq!")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_one")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pub")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fn")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add_one")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" i32"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("->")]),s._v(" i32 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("然后在 workspace 目录上执行 "),t("code",[s._v("cargo test")]),s._v(" ：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n\nRunning target/debug/deps/add_one-16176d07b356d257\n\trunning "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" tests::it_works "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". ok\n\nRunning target/debug/deps/adder-5042be8a3a766849\n\trunning "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" tests\n\nDoc-tests add-one\n\trunning "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" tests\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("可以看到：")]),s._v(" "),t("ul",[t("li",[s._v("先执行 "),t("code",[s._v("add-one")]),s._v(" 的测试，有 1 个")]),s._v(" "),t("li",[s._v("再执行 "),t("code",[s._v("adder")]),s._v(" 的测试，有 0 个")]),s._v(" "),t("li",[s._v("最后是 "),t("code",[s._v("add-one")]),s._v(" 的 Doc-test")])]),s._v(" "),t("p",[s._v("然后使用 "),t("code",[s._v("-p")]),s._v(" 来指定：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ cargo "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -p add-one\n\nRunning target/debug/deps/add_one-16176d07b356d257\n\trunning "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" tests::it_works "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". ok\n\nDoc-tests add-one\n\trunning "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" tests\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("可以看到：")]),s._v(" "),t("ul",[t("li",[s._v("先执行 "),t("code",[s._v("add-one")]),s._v(" 的测试，有 1 个")]),s._v(" "),t("li",[s._v("然后没有执行 "),t("code",[s._v("adder")]),s._v(" 的测试，因为未被指定")]),s._v(" "),t("li",[s._v("最后是 "),t("code",[s._v("add-one")]),s._v(" 的 Doc-test")])]),s._v(" "),t("h2",{attrs:{id:"最后"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[s._v("#")]),s._v(" 最后")]),s._v(" "),t("p",[s._v("该 workspace 还有一个 library crate ，也就是 "),t("code",[s._v("add-two")]),s._v(" ，添加方式与 "),t("code",[s._v("add-one")]),s._v(" 一致。本文对应的源码中已添加。")])])}),[],!1,null,null,null);a.default=e.exports}}]);