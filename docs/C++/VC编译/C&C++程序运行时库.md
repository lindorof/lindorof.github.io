---
sidebar: auto
sidebarDepth: 2
---

# C & C++ 程序运行时库

## 概述  

运行时库是C/C++运行时所需的库，以 `LIB/DLL` 的形式提供，运行时库有几个作用：

1. 提供必要的库函数调用，例如 `strcpy` , `memcpy` , `malloc` 等；
2. 为应用程序添加启动函数，启动函数的主要功能为：
    - 进行程序的初始化
    - 对全局变量进行赋初值
    - 加载用户程序的入口函数等

> 运行时库诞生于20世纪70年代，从最开始的单线程运行时库演化到现在的多线程运行时库，因此有几个版本：

1. SingleThread (LIB) `/ML` ( `libc.lib` )
2. MultiThread (LIB) `/MT` ( `libcmt.lib` )
3. MultiThread (DLL) `/MD` ( `msvcrt.lib` )

其中：

1. 每个运行时库都有 DEBUG 版本，对应的编译选项和所链接的库都是在末尾加上 `d` ，例如 `/MTd` ( `libcmtd.lib` )
2. 对于 `/MD`，运行时的 DLL 为 `msvcrtXXX.dll` ，其中 `XXX` 为版本号

***单线程*** 运行时库的特性：

1. 只能用在单线程的程序中；
2. 不具备多线程特性，例如 `errno` 是全局的，多个线程可能相互修改和冲突，导致无法获取到正确的值；

***多线程*** 运行时库的特性：

1. 可以用在多线程的程序中；
2. 类似 `errno` 这种全局变量，会为每个线程单独设置一个，从而每个线程的全局变量都是独立的，不会在多线程之间冲突；
3. 多线程运行时库中的数据结构有同步保护机制，避免多线程访问的冲突；



## `/ML`  

1. 只能用在 ***单线程*** 的程序中；
2. 运行时库会编译在应用程序的二进制代码中；
3. 因此 ***应用程序拥有独立的运行时库*** ；



## `/MT`  

1. 可以用在 ***多线程*** 的程序中；
2. 运行时库会编译在应用程序的二进制代码中；
3. 因此 ***应用程序拥有独立的运行时库*** ；
4. 如果应用程序是 DLL ，则 DLL 拥有自己独立的运行时库，那么，***DLL 自身分配的内存也只能由 DLL 进行释放*** ，不能由调用者释放；
5. 由于应用程序拥有独立的运行时库，因此应用程序 不会依赖于特定版本的系统运行时库 ；



## `/MD`  

1. 可以用在 ***多线程*** 的程序中；
2. 运行时库不会编译在应用程序的二进制代码中；
3. 因此 ***应用程序没有独立的运行时库*** ；
4. 所以，应用程序会依赖于系统的 `msvcrtXXX.dll` ，且版本可能不同；
5. 由于应用程序没有独立的运行时库，因此如果应用程序是DLL，则 ***DLL自身分配的内存可以由调用者来释放*** ；
6. 但是，程序设计时，内存分配原则是「***谁分配则谁释放***」，因此即使使用该编译选项，也不要让调用者释放DLL的内存；

